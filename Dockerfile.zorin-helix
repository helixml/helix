# ====================================================================
# Go build stage for settings-sync-daemon and screenshot-server
# ====================================================================
FROM golang:1.24 AS go-build-env
WORKDIR /app
COPY go.mod go.sum ./
RUN --mount=type=cache,target=/go/pkg/mod go mod download
COPY api ./api
WORKDIR /app/api
RUN --mount=type=cache,target=/go/pkg/mod \
    --mount=type=cache,target=/root/.cache/go-build \
    CGO_ENABLED=0 go build -buildvcs=false -ldflags "-s -w" -o /settings-sync-daemon ./cmd/settings-sync-daemon && \
    CGO_ENABLED=0 go build -buildvcs=false -ldflags "-s -w" -o /screenshot-server ./cmd/screenshot-server && \
    CGO_ENABLED=0 go build -buildvcs=false -ldflags "-s -w" -o /revdial-client ./cmd/revdial-client

# ====================================================================
# Zorin OS Personal Dev Environment - Stage 2: Add Zed Integration
# ====================================================================
FROM ghcr.io/mollomm1/gow-zorin-18:latest

# CRITICAL FIX: Override RUN_SWAY from base image - Zorin uses GNOME, not Sway
# The GOW Zorin base incorrectly inherits RUN_SWAY=1 which causes the container to fail
ENV RUN_SWAY=""

# CRITICAL FIX: Zorin base image init script expects XDG_RUNTIME_DIR but doesn't set it
# This causes "chown: cannot access '': No such file or directory" and container exits
ENV XDG_RUNTIME_DIR=/run/user/1000
RUN mkdir -p /run/user/1000 && chmod 700 /run/user/1000

# CRITICAL FIX: Disable systemd-logind (not available in containers)
# GNOME session manager tries to connect to systemd-logind for session management
# In containers without systemd, this causes GNOME to fail and enter "failed session" mode
RUN for file in $(find /usr -type f -iname "*login1*" 2>/dev/null); do \
    mv -v "$file" "$file.back" 2>/dev/null || true; \
    done

# Enable bubblewrap (bwrap) for application sandboxing - needed by GNOME
RUN chmod u+s /usr/bin/bwrap 2>/dev/null || true

# Ensure dbus-x11 is installed (required for D-Bus in X11 sessions)
RUN apt-get update && \
    apt-get install -y dbus-x11 && \
    rm -rf /var/lib/apt/lists/*

# Add passwordless sudo (needed for Zed startup script to create symlinks)
RUN apt-get update && \
    apt-get install -y sudo && \
    echo "%sudo ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers && \
    echo "retro ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers && \
    echo "user ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers && \
    rm -rf /var/lib/apt/lists/*

# Install screenshot tools: grim for Wayland/Sway, scrot for X11/GNOME
RUN apt-get update && \
    apt-get install -y grim scrot && \
    rm -rf /var/lib/apt/lists/*

# Install Firefox browser from Mozilla repository (for taskbar and general use)
RUN apt-get update && \
    apt-get install -y wget gnupg && \
    mkdir -p /etc/apt/keyrings && \
    wget -q https://packages.mozilla.org/apt/repo-signing-key.gpg -O /etc/apt/keyrings/packages.mozilla.org.asc && \
    echo "deb [signed-by=/etc/apt/keyrings/packages.mozilla.org.asc] https://packages.mozilla.org/apt mozilla main" > /etc/apt/sources.list.d/mozilla.list && \
    echo "Package: firefox*\nPin: origin packages.mozilla.org\nPin-Priority: 1000" > /etc/apt/preferences.d/mozilla-firefox && \
    apt-get update && \
    apt-get install -y firefox && \
    rm -rf /var/lib/apt/lists/*

# Install Docker CLI only (daemon on host via socket mount)
# Note: Uses 'jammy' (22.04) for Zorin 18 compatibility (Zorin 18 = Ubuntu 22.04)
RUN apt-get update \
    && apt-get install -y --no-install-recommends gnupg ca-certificates curl \
    && install -m 0755 -d /etc/apt/keyrings \
    && curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg \
    && chmod a+r /etc/apt/keyrings/docker.gpg \
    && echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu jammy stable" > /etc/apt/sources.list.d/docker.list \
    && apt-get update \
    && apt-get install -y docker-ce-cli docker-compose-plugin \
    && rm -rf /var/lib/apt/lists/*

# Install Docker CLI and Compose wrappers that resolve symlinks for Hydra compatibility
# These wrappers intercept docker/compose commands and resolve symlinks in volume
# paths before passing to the real binaries, enabling bind mounts to work
# correctly when using Hydra (nested dockerd per session).
COPY wolf/zorin-config/docker-wrapper.sh /usr/local/bin/docker-wrapper.sh
COPY wolf/zorin-config/docker-compose-wrapper.sh /usr/local/bin/docker-compose-wrapper.sh
RUN mv /usr/bin/docker /usr/bin/docker.real \
    && mv /usr/local/bin/docker-wrapper.sh /usr/bin/docker \
    && chmod 755 /usr/bin/docker /usr/bin/docker.real \
    && mv /usr/libexec/docker/cli-plugins/docker-compose /usr/libexec/docker/cli-plugins/docker-compose.real \
    && mv /usr/local/bin/docker-compose-wrapper.sh /usr/libexec/docker/cli-plugins/docker-compose \
    && chmod 755 /usr/libexec/docker/cli-plugins/docker-compose /usr/libexec/docker/cli-plugins/docker-compose.real

# Install clipboard tools for X11 clipboard sync (Zorin uses X11, not Wayland)
RUN apt-get update && apt-get install -y \
    xclip xsel \
    && rm -rf /var/lib/apt/lists/*

# Install git for repository cloning
RUN apt-get update && apt-get install -y \
    git openssh-client \
    && rm -rf /var/lib/apt/lists/*

# Install window management tools for tiling (Terminal, Zed, Firefox in thirds)
# - wmctrl: Position windows by ID
# - xdotool: Search and manipulate windows
# - devilspie2: Daemon that applies geometry rules to new windows
RUN apt-get update && apt-get install -y \
    wmctrl xdotool devilspie2 \
    && rm -rf /var/lib/apt/lists/*

# Copy settings-sync-daemon, screenshot-server, and revdial-client binaries from Go build stage
COPY --from=go-build-env /settings-sync-daemon /usr/local/bin/settings-sync-daemon
COPY --from=go-build-env /screenshot-server /usr/local/bin/screenshot-server
COPY --from=go-build-env /revdial-client /usr/local/bin/revdial-client

# ====================================================================
# Install Node.js for qwen-code
# ====================================================================
RUN curl -fsSL https://deb.nodesource.com/setup_22.x | bash - && \
    apt-get install -y nodejs && \
    rm -rf /var/lib/apt/lists/*

# ====================================================================
# Install qwen-code (Helix's Qwen Code agent CLI)
# ====================================================================
# SECURITY: We build from our fork of qwen-code (github.com/helixml/qwen-code)
# with audited commits and critical bug fixes.
#
# BUILD APPROACH: Copy pre-built qwen-code from local directory
# This is faster during development and ensures we're using our fixes.
# The qwen-code-build directory must be prepared by ./stack build-zorin
#
# CACHE BUSTING: QWEN_CODE_HASH build arg changes when qwen-code source changes,
# ensuring Docker rebuilds this layer with the latest code.
ARG QWEN_CODE_HASH=unknown
WORKDIR /opt/qwen-code
COPY qwen-code-build/ ./
RUN echo "qwen-code commit: ${QWEN_CODE_HASH}" && \
    echo "Fixes: [object Object] error display + shell security disabled" && \
    npm install -g . && \
    npm cache clean --force

WORKDIR /

# Copy Zed binary (built with ./stack build-zed before Docker build)
# CRITICAL: Must be built with --features external_websocket_sync
RUN mkdir -p /zed-build
COPY zed-build/zed /zed-build/zed
RUN chmod +x /zed-build/zed

# Copy Zed startup script and helper scripts
ADD wolf/zorin-config/start-zed-helix.sh /usr/local/bin/start-zed-helix.sh
ADD wolf/zorin-config/helix-specs-create.sh /usr/local/bin/helix-specs-create.sh
RUN chmod +x /usr/local/bin/start-zed-helix.sh /usr/local/bin/helix-specs-create.sh

# Copy GOW startup script (creates autostart entries and state symlinks)
ADD wolf/zorin-config/startup-app.sh /opt/gow/startup.sh
RUN chmod +x /opt/gow/startup.sh

# Add retro user to docker group at runtime (after GOW creates user AND after 15-setup_devices.sh)
# CRITICAL: Must be 16+ because 15-setup_devices.sh uses "usermod -G" (not -aG) which REPLACES groups
ADD wolf/zorin-config/16-add-docker-group.sh /etc/cont-init.d/16-add-docker-group.sh
RUN chmod 755 /etc/cont-init.d/16-add-docker-group.sh

# Copy Helix background image for desktop wallpaper
RUN mkdir -p /usr/share/backgrounds
COPY wolf/assets/images/helix_hero.png /usr/share/backgrounds/helix-hero.png

# Copy GNOME dconf settings (background, theme, keyboard, power management)
COPY wolf/zorin-config/dconf-settings.ini /opt/gow/dconf-settings.ini
