# ====================================================================
# Go build stage for screenshot-server and settings-sync-daemon
# ====================================================================
FROM golang:1.24 AS go-build-env
WORKDIR /app
COPY go.mod go.sum ./
RUN --mount=type=cache,target=/go/pkg/mod go mod download
COPY api ./api
WORKDIR /app/api
RUN --mount=type=cache,target=/go/pkg/mod \
    --mount=type=cache,target=/root/.cache/go-build \
    CGO_ENABLED=0 go build -buildvcs=false -ldflags "-s -w" -o /screenshot-server ./cmd/screenshot-server && \
    CGO_ENABLED=0 go build -buildvcs=false -ldflags "-s -w" -o /settings-sync-daemon ./cmd/settings-sync-daemon && \
    CGO_ENABLED=0 go build -buildvcs=false -ldflags "-s -w" -o /revdial-client ./cmd/revdial-client

# ====================================================================
# Patched wlroots build stage (Debian package rebuild)
# ====================================================================
# Rebuild libwlroots12 with our keyboard layout fix patch.
# This fixes a bug where pressing modifier keys (Shift/Ctrl/Alt) would
# reset the keyboard layout to US when running Sway as a nested compositor.
#
# We use Debian's packaging system (dpkg-buildpackage + quilt patches)
# which is the cleanest way to maintain custom library patches.
#
# The patch adds WLR_IGNORE_PARENT_KEYBOARD_LAYOUT environment variable
# that, when set to "1", preserves Sway's own keyboard layout instead of
# syncing to the parent compositor's layout.
#
# Version suffix: -helix1 indicates our custom patch
# ====================================================================
FROM ubuntu:25.04 AS wlroots-build

# Enable source repositories and install build dependencies
RUN sed -i 's/^Types: deb$/Types: deb deb-src/' /etc/apt/sources.list.d/ubuntu.sources && \
    apt-get update && \
    apt-get install -y dpkg-dev devscripts quilt && \
    apt-get build-dep -y libwlroots12t64 && \
    rm -rf /var/lib/apt/lists/*

# Get the source package
WORKDIR /build
RUN apt-get update && apt-get source libwlroots12t64

# Copy our patch into the Debian patches directory
COPY wolf/wlroots-patches/0001-wayland-backend-ignore-parent-layout-group.patch /build/
RUN cd /build/wlroots-* && \
    mkdir -p debian/patches && \
    cp /build/0001-wayland-backend-ignore-parent-layout-group.patch debian/patches/ && \
    echo "0001-wayland-backend-ignore-parent-layout-group.patch" >> debian/patches/series

# Update the version to indicate our custom build
RUN cd /build/wlroots-* && \
    dch --local helix "Add WLR_IGNORE_PARENT_KEYBOARD_LAYOUT to fix nested compositor layout reset"

# Build the package
RUN cd /build/wlroots-* && \
    dpkg-buildpackage -us -uc -b

# ====================================================================
# Sway Personal Dev Environment
# ====================================================================
FROM ghcr.io/games-on-whales/base-app:edge

# ====================================================================
# Install patched wlroots library
# ====================================================================
# Replace the stock wlroots with our patched version that fixes the
# keyboard layout reset bug when running Sway as a nested compositor.
# The patched library adds WLR_IGNORE_PARENT_KEYBOARD_LAYOUT support.
#
# We copy the .deb package from our build stage and install it, which
# properly replaces the stock libwlroots12t64 package.
COPY --from=wlroots-build /build/*.deb /tmp/wlroots/
RUN dpkg -i /tmp/wlroots/libwlroots12*.deb && rm -rf /tmp/wlroots

# Enable the keyboard layout fix - this tells wlroots to preserve Sway's
# own keyboard layout instead of syncing to the parent compositor's layout.
ENV WLR_IGNORE_PARENT_KEYBOARD_LAYOUT=1

# Add passwordless sudo and basic tools
RUN apt-get update && \
    apt-get install -y sudo wget curl ca-certificates gnupg software-properties-common && \
    # Add passwordless sudo for all users in group 1000 (retro/user will be in this group)
    echo "%sudo ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers && \
    echo "retro ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers && \
    echo "user ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers && \
    # Clean up apt cache
    rm -rf /var/lib/apt/lists/*

# Install Firefox from Mozilla Team PPA (following GOW pattern)
COPY <<_APT_PIN /etc/apt/preferences.d/mozilla-firefox
Package: *
Pin: release o=LP-PPA-mozillateam
Pin-Priority: 1001
_APT_PIN

RUN apt-get update \
    && apt-get install -y --no-install-recommends software-properties-common gpg-agent \
    && add-apt-repository ppa:mozillateam/ppa \
    && apt-get install -y --no-install-recommends firefox libavcodec-extra \
    && apt-get remove -y software-properties-common gpg-agent \
    && apt-get autoremove -y \
    && rm -rf /var/lib/apt/lists/*

# Install Docker CLI only (daemon on host via socket mount)
RUN apt-get update \
    && apt-get install -y --no-install-recommends gnupg ca-certificates curl \
    && install -m 0755 -d /etc/apt/keyrings \
    && curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg \
    && chmod a+r /etc/apt/keyrings/docker.gpg \
    && echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu plucky stable" > /etc/apt/sources.list.d/docker.list \
    && apt-get update \
    && apt-get install -y docker-ce-cli docker-compose-plugin \
    && rm -rf /var/lib/apt/lists/*
    # Note: docker group is created at runtime by 16-add-docker-group.sh
    # with the correct GID matching the mounted socket from sandbox

# Install Docker CLI and Compose wrappers that resolve symlinks for Hydra compatibility
# These wrappers intercept docker/compose commands and resolve symlinks in volume
# paths before passing to the real binaries, enabling bind mounts to work
# correctly when using Hydra (nested dockerd per session).
COPY wolf/sway-config/docker-wrapper.sh /usr/local/bin/docker-wrapper.sh
COPY wolf/sway-config/docker-compose-wrapper.sh /usr/local/bin/docker-compose-wrapper.sh
RUN mv /usr/bin/docker /usr/bin/docker.real \
    && mv /usr/local/bin/docker-wrapper.sh /usr/bin/docker \
    && chmod 755 /usr/bin/docker /usr/bin/docker.real \
    && mv /usr/libexec/docker/cli-plugins/docker-compose /usr/libexec/docker/cli-plugins/docker-compose.real \
    && mv /usr/local/bin/docker-compose-wrapper.sh /usr/libexec/docker/cli-plugins/docker-compose \
    && chmod 755 /usr/libexec/docker/cli-plugins/docker-compose /usr/libexec/docker/cli-plugins/docker-compose.real

# Install grim, lsof, git, bash, OnlyOffice, Ghostty, and emoji fonts
RUN apt-get update && apt-get install -y \
    # Screenshot tool for Wayland and debugging utilities
    grim lsof \
    # Clipboard tools for Wayland clipboard sync
    wl-clipboard \
    # Input device testing tools for keyboard state observability
    evtest evemu-tools \
    # Shell and Git for repository access
    bash git openssh-client \
    # Emoji and icon fonts for waybar
    fonts-noto-color-emoji fonts-font-awesome fonts-dejavu-core \
    # OnlyOffice Desktop Editors
    && wget -q -O /tmp/onlyoffice.deb "https://github.com/ONLYOFFICE/DesktopEditors/releases/download/v8.2.1/onlyoffice-desktopeditors_amd64.deb" \
    && dpkg -i /tmp/onlyoffice.deb || apt-get install -yf \
    && rm /tmp/onlyoffice.deb \
    # GTK and GUI dependencies for Ghostty
    && apt-get install -y libgtk-4-dev libgtk-4-1 libadwaita-1-0 \
    libgraphene-1.0-0 libcairo2 libcairo-gobject2 \
    libgdk-pixbuf-2.0-0 libpango-1.0-0 libpangocairo-1.0-0 \
    libfontconfig1 libfreetype6 libharfbuzz0b \
    libglib2.0-0 libgobject-2.0-0 libgio-2.0-0 \
    # Additional runtime dependencies
    libegl1 libgl1 libwayland-client0 libwayland-cursor0 libwayland-egl1 \
    libx11-6 libxcomposite1 libxdamage1 libxext6 libxfixes3 libxi6 libxrandr2 \
    && wget -q -O /tmp/ghostty.deb "https://github.com/mkasberg/ghostty-ubuntu/releases/download/1.1.3-0-ppa2/ghostty_1.1.3-0.ppa2_amd64_25.04.deb" \
    && dpkg -i /tmp/ghostty.deb && rm /tmp/ghostty.deb \
    && rm -rf /var/lib/apt/lists/*

# Download and set Helix logo as background
RUN mkdir -p /usr/share/backgrounds && \
    wget -O /usr/share/backgrounds/helix-logo.png https://helix.ml/assets/helix-logo.png

# ====================================================================
# Install Node.js 20 (required for AI coding agents)
# ====================================================================
# CACHE OPTIMIZATION: Node.js and Qwen Code rarely change, so install early
# to avoid re-building on every sway config or script change.
RUN apt-get update && \
    apt-get install -y ca-certificates curl gnupg git && \
    mkdir -p /etc/apt/keyrings && \
    curl -fsSL https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key | gpg --dearmor -o /etc/apt/keyrings/nodesource.gpg && \
    echo "deb [signed-by=/etc/apt/keyrings/nodesource.gpg] https://deb.nodesource.com/node_20.x nodistro main" > /etc/apt/sources.list.d/nodesource.list && \
    apt-get update && \
    apt-get install -y nodejs && \
    rm -rf /var/lib/apt/lists/*

# ====================================================================
# Build Qwen Code from AUDITED source (NOT from npm)
# ====================================================================
# SECURITY: We build from the GitHub source we've audited rather than trusting
# the npm package, which could differ from the source or be compromised.
# This ensures the code running matches our security audit.
#
# CACHE OPTIMIZATION: This slow build (~2-3 min) rarely changes, so it's placed
# early in the Dockerfile before frequently-changing sway configs and scripts.
WORKDIR /tmp/qwen-code-build
RUN git clone https://github.com/QwenLM/qwen-code.git . && \
    # Pin to specific audited commit for reproducibility and audit trail
    # Commit: c9af7481 "fix: reset authType settings (#1091)"
    # Audit Date: 2025-01-24
    # Security Audit: PASSED (zero backdoors, zero hidden telemetry)
    git checkout c9af7481 && \
    npm install && \
    npm run build && \
    # Install globally from the built source
    npm install -g . && \
    # Clean up build artifacts
    cd / && rm -rf /tmp/qwen-code-build && \
    npm cache clean --force

# ====================================================================
# Frequently-changing files below (cache invalidation expected)
# ====================================================================

# Copy Sway custom configuration (placed in image, GOW will set up proper user directories at runtime)
RUN mkdir -p /cfg/sway
ADD wolf/sway-config/config /cfg/sway/custom-cfg

# Copy and setup Zed startup script and helper scripts
ADD wolf/sway-config/start-zed-helix.sh /usr/local/bin/start-zed-helix.sh
ADD wolf/sway-config/helix-specs-create.sh /usr/local/bin/helix-specs-create.sh
RUN chmod +x /usr/local/bin/start-zed-helix.sh /usr/local/bin/helix-specs-create.sh

# Copy GOW startup script
ADD wolf/sway-config/startup-app.sh /opt/gow/startup-app.sh
RUN chmod +x /opt/gow/startup-app.sh

# Add retro user to docker group at runtime (after GOW creates user AND after 15-setup_devices.sh)
# CRITICAL: Must be 16+ because 15-setup_devices.sh uses "usermod -G" (not -aG) which REPLACES groups
ADD wolf/sway-config/16-add-docker-group.sh /etc/cont-init.d/16-add-docker-group.sh
RUN chmod 755 /etc/cont-init.d/16-add-docker-group.sh

# Copy welcome README template for workspace initialization
RUN mkdir -p /opt/helix
ADD WORKDIR_README.md /opt/helix/WORKDIR_README.md

# Copy screenshot-server and settings-sync-daemon binaries from Go build stage
COPY --from=go-build-env /screenshot-server /usr/local/bin/screenshot-server
COPY --from=go-build-env /settings-sync-daemon /usr/local/bin/settings-sync-daemon
COPY --from=go-build-env /revdial-client /usr/local/bin/revdial-client

# Copy Zed binary (built with ./stack build-zed before Docker build)
# CRITICAL: Must be built with --features external_websocket_sync
RUN mkdir -p /zed-build
COPY zed-build/zed /zed-build/zed
RUN chmod +x /zed-build/zed

# Create Qwen Code configuration directory for retro user
# IMPORTANT: This configuration DISABLES all telemetry and auto-updates
RUN mkdir -p /home/retro/.qwen && \
    cat > /home/retro/.qwen/settings.json <<'QWEN_CONFIG'
{
  "privacy": {
    "usageStatisticsEnabled": false
  },
  "general": {
    "disableAutoUpdate": true,
    "disableUpdateNag": true
  }
}
QWEN_CONFIG

# ====================================================================
# Configure Gemini CLI (if installed) - Same privacy settings as Qwen Code
# ====================================================================
# Gemini CLI uses identical telemetry settings (Qwen Code is a fork)
RUN mkdir -p /home/retro/.gemini && \
    cat > /home/retro/.gemini/settings.json <<'GEMINI_CONFIG'
{
  "privacy": {
    "usageStatisticsEnabled": false
  },
  "general": {
    "disableAutoUpdate": true,
    "disableUpdateNag": true
  }
}
GEMINI_CONFIG

# ====================================================================
# Configure Claude Code CLI Privacy Settings
# ====================================================================
RUN mkdir -p /home/retro/.claude && \
    cat > /home/retro/.claude/settings.json <<'CLAUDE_CONFIG'
{
  "env": {
    "CLAUDE_CODE_DISABLE_NONESSENTIAL_TRAFFIC": "1",
    "DISABLE_TELEMETRY": "1",
    "DISABLE_ERROR_REPORTING": "1",
    "DISABLE_AUTOUPDATER": "1"
  }
}
CLAUDE_CONFIG

# ====================================================================
# Configure Zed Editor Privacy Settings + Qwen Code ACP Agent
# ====================================================================
RUN mkdir -p /home/retro/.config/zed && \
    cat > /home/retro/.config/zed/settings.json <<'ZED_CONFIG'
{
  "telemetry": {
    "diagnostics": false,
    "metrics": false
  },
  "agent_servers": {
    "qwen": {
      "type": "custom",
      "command": "qwen",
      "args": [
        "--experimental-acp",
        "--no-telemetry"
      ],
      "env": {
        "GEMINI_TELEMETRY_ENABLED": "false",
        "OPENAI_BASE_URL": "http://host.docker.internal:8080/api/v1"
      }
    }
  },
  "default_agent": "qwen"
}
ZED_CONFIG

# ====================================================================
# Set environment variables for AI agent privacy (defense-in-depth)
# ====================================================================
ENV GEMINI_TELEMETRY_ENABLED=false \
    CLAUDE_CODE_DISABLE_NONESSENTIAL_TRAFFIC=1 \
    DISABLE_TELEMETRY=1 \
    DISABLE_ERROR_REPORTING=1 \
    DISABLE_AUTOUPDATER=1

# Configure Kitty terminal (system-wide, since /home/retro is bind-mounted)
RUN mkdir -p /etc/xdg/kitty && \
    cat > /etc/xdg/kitty/kitty.conf <<'KITTY_CONFIG'
# Close window when shell exits (don't leave orphan windows)
close_on_child_death yes

# Dark theme
background #1e1e2e
foreground #cdd6f4
KITTY_CONFIG

# Fix ownership - all configs must be owned by retro user (UID/GID 1000)
RUN chown -R 1000:1000 /home/retro/.qwen \
                        /home/retro/.gemini \
                        /home/retro/.claude \
                        /home/retro/.config/zed

# ====================================================================
# AI Agent Privacy Configuration Summary
# ====================================================================
# NOTE: OS-level telemetry firewall (iptables) is configured in the
# sandbox container (Wolf host), not inside agent containers. This allows:
#   - Centralized monitoring across all agents
#   - Per-agent telemetry tracking (by container IP/name)
#   - No iptables dependency in agent containers
#
# ====================================================================
# The above configuration ensures ALL AI coding agents are privacy-compliant:
#
# QWEN CODE (built from audited source, NOT npm):
#   - Source: Built from https://github.com/QwenLM/qwen-code (audited commit)
#   - Config: /home/retro/.qwen/settings.json
#   - Telemetry: DISABLED (Alibaba Cloud + Google blocked)
#   - Auto-update: DISABLED
#   - Env: GEMINI_TELEMETRY_ENABLED=false
#   - Firewall: gb4w8c3ygj-default-sea.rum.aliyuncs.com, play.googleapis.com
#
# GEMINI CLI (if installed):
#   - Config: /home/retro/.gemini/settings.json
#   - Telemetry: DISABLED (same system as Qwen Code)
#   - Auto-update: DISABLED
#   - Firewall: Covered by Qwen Code rules
#
# CLAUDE CODE (if installed):
#   - Config: /home/retro/.claude/settings.json
#   - Telemetry: DISABLED (Statsig blocked)
#   - Error reporting: DISABLED
#   - Auto-update: DISABLED
#   - Env: CLAUDE_CODE_DISABLE_NONESSENTIAL_TRAFFIC=1
#   - Firewall: statsig, telemetry.anthropic.com
#
# ZED EDITOR:
#   - Config: /home/retro/.config/zed/settings.json
#   - Diagnostics: DISABLED (crash reports blocked)
#   - Metrics: DISABLED (usage stats blocked)
#   - Firewall: telemetry.zed.dev, zed.dev/api
#
# DEFENSE-IN-DEPTH LAYERS:
#   1. Application config files (per-agent settings.json)
#   2. Environment variables (global ENV in Dockerfile)
#   3. OS-level iptables firewall (blocks even if configs bypassed)
#   4. iptables counters (detect and log all phone-home attempts)
#   5. Dashboard monitoring (real-time visibility in Helix UI)
#
# Monitoring:
#   - Blocked attempts logged to: /var/log/telemetry-blocks.log
#   - Counter metrics in: /var/run/telemetry-counters.json
#   - Dashboard API: GET /api/v1/security/telemetry-status
#
# For self-hosted AI models, also set in Wolf app environment:
#   export OPENAI_API_KEY="your-internal-api-key"
#   export OPENAI_BASE_URL="http://your-internal-qwen-server:port/v1"
# ====================================================================
