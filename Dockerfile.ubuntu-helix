# ====================================================================
# Go build stage for settings-sync-daemon, screenshot-server, revdial-client
# ====================================================================
FROM golang:1.24 AS go-build-env
WORKDIR /app
COPY go.mod go.sum ./
RUN --mount=type=cache,target=/go/pkg/mod go mod download
COPY api ./api
WORKDIR /app/api
RUN --mount=type=cache,target=/go/pkg/mod \
    --mount=type=cache,target=/root/.cache/go-build \
    CGO_ENABLED=0 go build -buildvcs=false -ldflags "-s -w" -o /settings-sync-daemon ./cmd/settings-sync-daemon && \
    CGO_ENABLED=0 go build -buildvcs=false -ldflags "-s -w" -o /screenshot-server ./cmd/screenshot-server && \
    CGO_ENABLED=0 go build -buildvcs=false -ldflags "-s -w" -o /revdial-client ./cmd/revdial-client

# ====================================================================
# Pure Ubuntu 22.04 GNOME Personal Dev Environment
# ====================================================================
# GNOME 42 on Ubuntu 22.04 LTS - proven stable with Xwayland/Gamescope
# No MIT-SHM crashes (those were GNOME 48 specific)
# Enterprise-grade LTS with 5-10 year support
FROM ubuntu:22.04

# GOW environment variables
ENV DEBIAN_FRONTEND=noninteractive
ENV UNAME=retro
ENV UGROUP=retro
ENV HOME=/home/retro
ENV UID=1000
ENV GID=1000
ENV PUID=1000
ENV PGID=1000
ENV UMASK=000
ENV XDG_RUNTIME_DIR=/run/user/1000
ENV DISPLAY=:9

# ====================================================================
# Install base system dependencies
# ====================================================================
RUN apt-get update && apt-get install -y \
    # GOW infrastructure
    gosu sudo dbus dbus-x11 \
    # Xwayland and X11 utilities
    xwayland x11-xserver-utils xdotool x11-utils \
    # PulseAudio for sound
    pulseaudio libpulse0 \
    # Basic utilities
    curl wget ca-certificates gnupg locales \
    # ImageMagick for icon resizing
    imagemagick \
    && rm -rf /var/lib/apt/lists/*

# Set up locales
RUN locale-gen en_US.UTF-8
ENV LANG=en_US.UTF-8
ENV LC_ALL=en_US.UTF-8

# ====================================================================
# Build libdrm + Mesa from source for AMD RDNA 3 (gfx1101) support
# ====================================================================
# Ubuntu 22.04's default Mesa 23.2 + libdrm 2.4.113 causes GPU crashes on
# AMD Radeon Pro V710 MxGPU (gfx1101/RDNA 3) with ROCm 6.16+ kernel driver.
# The Mesa PPAs have dropped 22.04 support, so we build from source.
#
# Mesa 25.0.7 gives better error messages ("Illegal opcode in command stream")
# than older versions which just showed NULL pointer page faults.
#
# DEBUG: Set RADV_DEBUG=hang to get command stream decode on crash.
# DEBUG: UMR is installed for GPU wave/register inspection.
#
# This adds ~10-15 min to build time but ensures proper crash debugging.
ARG LIBDRM_VERSION=2.4.124
ARG MESA_VERSION=25.0.7
ARG SPIRV_LLVM_TRANSLATOR_VERSION=18.1.3
ARG SPIRV_TOOLS_VERSION=vulkan-sdk-1.4.304.0

# Add LLVM 18 repository (Ubuntu 22.04 only has LLVM 15, Mesa 25.x requires 18)
RUN apt-get update && apt-get install -y wget gnupg software-properties-common && \
    wget -qO- https://apt.llvm.org/llvm-snapshot.gpg.key | tee /etc/apt/trusted.gpg.d/apt.llvm.org.asc && \
    echo "deb http://apt.llvm.org/jammy/ llvm-toolchain-jammy-18 main" > /etc/apt/sources.list.d/llvm-18.list && \
    apt-get update && rm -rf /var/lib/apt/lists/*

# Install build dependencies (LLVM 18 for Mesa 25.x)
RUN apt-get update && apt-get install -y \
    # Build tools (meson from apt is too old, will install via pip)
    ninja-build cmake pkg-config python3 python3-pip python3-setuptools \
    python3-mako flex bison git \
    # libdrm build dependencies
    libpciaccess-dev \
    # Mesa dependencies
    libxcb1-dev libxcb-dri2-0-dev libxcb-dri3-dev libxcb-present-dev \
    libxcb-sync-dev libxcb-xfixes0-dev libxcb-shm0-dev libxcb-randr0-dev \
    libxcb-glx0-dev libxshmfence-dev libx11-xcb-dev libx11-dev libxext-dev \
    libxfixes-dev libxxf86vm-dev libxrandr-dev \
    libwayland-dev libwayland-egl-backend-dev wayland-protocols \
    libelf-dev zlib1g-dev libzstd-dev libexpat1-dev \
    # LLVM 18 from apt.llvm.org
    llvm-18-dev libclang-18-dev libclang-cpp18-dev clang-18 libclc-18-dev \
    libvulkan-dev glslang-dev glslang-tools \
    libva-dev libvdpau-dev libglvnd-dev \
    # Runtime dependencies
    libvulkan1 vulkan-tools mesa-utils \
    # UMR dependencies for GPU debugging
    libncurses-dev libpciaccess0 libsdl2-dev \
    && rm -rf /var/lib/apt/lists/*

# Install newer meson via pip (Mesa 25.x requires meson >= 1.1.0, Ubuntu 22.04 has 0.61)
# Also install ply for Intel Vulkan GRL kernels
RUN pip3 install "meson>=1.3.0" ply

# Build and install UMR (AMD GPU debugger) for crash analysis
# UMR can decode command streams, inspect waves, and read registers
RUN cd /tmp && \
    git clone https://gitlab.freedesktop.org/tomstdenis/umr.git && \
    cd umr && \
    mkdir build && cd build && \
    cmake -DCMAKE_INSTALL_PREFIX=/usr -DUMR_NO_GUI=ON -DUMR_NO_LLVM=ON .. && \
    make -j$(nproc) && \
    make install && \
    cd / && rm -rf /tmp/umr

# Build SPIRV-LLVM-Translator v18.1.3 from source (required for Intel Vulkan)
# Ubuntu's spirv-llvm-translator packages only go up to LLVM 15
# This provides LLVMSPIRVLib which Mesa's Intel ANV driver needs
# NO FALLBACKS - Intel support is required, fail if this doesn't build
RUN cd /tmp && \
    curl -L https://github.com/KhronosGroup/SPIRV-LLVM-Translator/archive/v${SPIRV_LLVM_TRANSLATOR_VERSION}.tar.gz -o spirv-llvm-translator.tar.gz && \
    tar xf spirv-llvm-translator.tar.gz && \
    cd SPIRV-LLVM-Translator-${SPIRV_LLVM_TRANSLATOR_VERSION} && \
    mkdir build && cd build && \
    cmake -DCMAKE_INSTALL_PREFIX=/usr \
          -DCMAKE_BUILD_TYPE=Release \
          -DBUILD_SHARED_LIBS=ON \
          -DCMAKE_SKIP_INSTALL_RPATH=ON \
          -DLLVM_DIR=/usr/lib/llvm-18/cmake \
          -G Ninja .. && \
    ninja -j$(nproc) && \
    ninja install && \
    ldconfig && \
    cd / && rm -rf /tmp/SPIRV-LLVM-Translator* /tmp/spirv-llvm-translator.tar.gz

# Build SPIRV-Tools from source (Mesa 25.x requires PR #5534 which is not in Ubuntu 22.04)
# This provides spirv-opt, spirv-val, etc. with SetAllowPtrTypeMismatch linker option
# NO FALLBACKS - required for Mesa CLC compiler, fail if this doesn't build
# Note: vulkan-sdk-1.4.304.0 requires specific SPIRV-Headers revision 3f17b2a
# Must install to x86_64-linux-gnu libdir for pkg-config to find it
RUN cd /tmp && \
    git clone --depth 1 --branch ${SPIRV_TOOLS_VERSION} https://github.com/KhronosGroup/SPIRV-Tools.git && \
    cd SPIRV-Tools && \
    git clone https://github.com/KhronosGroup/SPIRV-Headers.git external/spirv-headers && \
    cd external/spirv-headers && git checkout 3f17b2af6784bfa2c5aa5dbb8e0e74a607dd8b3b && cd ../.. && \
    mkdir build && cd build && \
    cmake -DCMAKE_INSTALL_PREFIX=/usr \
          -DCMAKE_INSTALL_LIBDIR=lib/x86_64-linux-gnu \
          -DCMAKE_BUILD_TYPE=Release \
          -DSPIRV_SKIP_TESTS=ON \
          -G Ninja .. && \
    ninja -j$(nproc) && \
    ninja install && \
    ldconfig && \
    cd / && rm -rf /tmp/SPIRV-Tools

# Build libdrm 2.4.124 (required for Mesa 25.x with RDNA 3)
# Enable AMD and Intel, disable nouveau (NVIDIA uses proprietary driver)
RUN cd /tmp && \
    curl -L https://dri.freedesktop.org/libdrm/libdrm-${LIBDRM_VERSION}.tar.xz -o libdrm.tar.xz && \
    tar xf libdrm.tar.xz && \
    cd libdrm-${LIBDRM_VERSION} && \
    meson setup build \
        --prefix=/usr \
        --libdir=/usr/lib/x86_64-linux-gnu \
        --buildtype=release \
        -Damdgpu=enabled \
        -Dradeon=enabled \
        -Dintel=enabled \
        -Dnouveau=disabled \
        -Dvmwgfx=disabled && \
    ninja -C build -j$(nproc) && \
    ninja -C build install && \
    ldconfig && \
    cd / && rm -rf /tmp/libdrm*

# Build Mesa 25.0.7 with drivers for AMD, Intel, and software rendering
# - AMD: radeonsi (OpenGL), amd/RADV (Vulkan)
# - Intel: iris (OpenGL Gen8+), crocus (OpenGL Gen4-7), intel/ANV (Vulkan), intel_hasvk (Vulkan Haswell)
# - Software: llvmpipe, softpipe (fallback)
# - Zink: OpenGL-on-Vulkan layer
# NVIDIA uses proprietary drivers mounted at runtime, not Mesa
RUN cd /tmp && \
    curl -L https://archive.mesa3d.org/mesa-${MESA_VERSION}.tar.xz -o mesa.tar.xz && \
    tar xf mesa.tar.xz && \
    cd mesa-${MESA_VERSION} && \
    meson setup build \
        --prefix=/usr \
        --libdir=/usr/lib/x86_64-linux-gnu \
        --buildtype=release \
        -Dplatforms=x11,wayland \
        -Dgallium-drivers=radeonsi,iris,crocus,llvmpipe,softpipe,zink \
        -Dvulkan-drivers=amd,intel,intel_hasvk \
        -Dglx=dri \
        -Degl=enabled \
        -Dgbm=enabled \
        -Dglvnd=enabled \
        -Dgles1=disabled \
        -Dgles2=enabled \
        -Dvalgrind=disabled \
        -Dlibunwind=disabled \
        -Dllvm=enabled \
        -Dshared-llvm=enabled \
        -Dgallium-opencl=disabled \
        -Dgallium-rusticl=false && \
    ninja -C build -j$(nproc) && \
    ninja -C build install && \
    ldconfig && \
    cd / && rm -rf /tmp/mesa*

# Set RADV debug options for crash analysis
# hang: Dump command stream and shaders on GPU hang/timeout
# This is CRITICAL for debugging the illegal opcode crashes
# Enables syncshaders (GPU command serialization) and hang detection.
# This may mask race conditions but provides crash dumps if issues occur.
# TODO: Test if Zed's restored wait_for_gpu() alone fixes crashes (see design doc)
ENV RADV_DEBUG=hang

# RadeonSI (OpenGL) debug options for GL apps
# sync_compile: Always compile shaders synchronously (prevents race conditions)
# check_vm: Check VM faults and dump debug info
# Note: RadeonSI doesn't have a syncshaders equivalent like RADV
ENV AMD_DEBUG=sync_compile,check_vm

# ====================================================================
# Install GNOME 42 Desktop (Ubuntu minimal)
# ====================================================================
RUN apt-get update && apt-get install -y \
    # Core GNOME components
    ubuntu-desktop-minimal \
    gnome-shell \
    gnome-session \
    mutter \
    gnome-settings-daemon \
    # File manager and terminal
    nautilus \
    gnome-terminal \
    # System utilities
    gnome-control-center \
    gnome-tweaks \
    # Keyring for browser password storage (auto-unlock with empty password)
    gnome-keyring libsecret-tools \
    # Ubuntu theming
    yaru-theme-gtk \
    yaru-theme-icon \
    yaru-theme-sound \
    ubuntu-wallpapers \
    fonts-ubuntu \
    # GNOME extensions for Ubuntu experience
    gnome-shell-extension-ubuntu-dock \
    gnome-shell-extension-appindicator \
    gnome-shell-extensions \
    # dconf for settings management
    dconf-cli dconf-editor \
    # XDG utilities
    xdg-utils \
    && rm -rf /var/lib/apt/lists/*

# Disable Ubuntu upgrade notifications (we're pinned to 22.04 LTS)
RUN sed -i 's/Prompt=.*/Prompt=never/' /etc/update-manager/release-upgrades || true

# ====================================================================
# Create GOW user and directory structure
# ====================================================================
RUN groupadd -g ${GID} ${UGROUP} && \
    useradd -m -d ${HOME} -u ${UID} -g ${GID} -s /bin/bash ${UNAME} && \
    echo "${UNAME} ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# Setup XDG runtime directory
RUN mkdir -p /run/user/1000 && \
    chmod 700 /run/user/1000 && \
    chown ${UID}:${GID} /run/user/1000

# ====================================================================
# CRITICAL: Disable systemd-logind (not available in containers)
# ====================================================================
# GNOME session manager tries to connect to systemd-logind for session management
RUN for file in $(find /usr -type f -iname "*login1*" 2>/dev/null); do \
    mv -v "$file" "$file.back" 2>/dev/null || true; \
    done

# Enable bubblewrap (bwrap) for application sandboxing - needed by GNOME
RUN chmod u+s /usr/bin/bwrap 2>/dev/null || true

# ====================================================================
# Install Firefox from Mozilla APT repo (Chrome has GPU issues on AMD MxGPU)
# Ubuntu 22.04's default firefox package is a snap transitional package
# which doesn't work in Docker containers. Use Mozilla's official repo.
# ====================================================================
RUN apt-get update && \
    apt-get install -y wget gnupg && \
    # Add Mozilla APT repository
    mkdir -p /etc/apt/keyrings && \
    wget -q https://packages.mozilla.org/apt/repo-signing-key.gpg -O /etc/apt/keyrings/packages.mozilla.org.asc && \
    echo "deb [signed-by=/etc/apt/keyrings/packages.mozilla.org.asc] https://packages.mozilla.org/apt mozilla main" > /etc/apt/sources.list.d/mozilla.list && \
    # Prefer Mozilla's Firefox over Ubuntu's snap transitional package
    echo 'Package: *\nPin: origin packages.mozilla.org\nPin-Priority: 1000' > /etc/apt/preferences.d/mozilla && \
    apt-get update && \
    apt-get install -y firefox && \
    rm -rf /var/lib/apt/lists/* && \
    # Configure Firefox policies to suppress first-run dialogs and sidebar
    mkdir -p /usr/lib/firefox/distribution && \
    echo '{ \
      "policies": { \
        "DisableFirstRunPage": true, \
        "DisableTelemetry": true, \
        "DontCheckDefaultBrowser": true, \
        "NoDefaultBookmarks": true, \
        "OfferToSaveLogins": true, \
        "PasswordManagerEnabled": true, \
        "Preferences": { \
          "sidebar.revamp": { \
            "Value": false, \
            "Status": "locked" \
          }, \
          "sidebar.verticalTabs": { \
            "Value": false, \
            "Status": "locked" \
          }, \
          "browser.tabs.tabmanager.enabled": { \
            "Value": false, \
            "Status": "locked" \
          } \
        } \
      } \
    }' > /usr/lib/firefox/distribution/policies.json

# ====================================================================
# Install Docker CLI (daemon on host via socket mount)
# ====================================================================
RUN apt-get update \
    && apt-get install -y --no-install-recommends gnupg ca-certificates curl \
    && install -m 0755 -d /etc/apt/keyrings \
    && curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg \
    && chmod a+r /etc/apt/keyrings/docker.gpg \
    && echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu jammy stable" > /etc/apt/sources.list.d/docker.list \
    && apt-get update \
    && apt-get install -y docker-ce-cli docker-compose-plugin \
    && rm -rf /var/lib/apt/lists/*

# Install Docker CLI and Compose wrappers that resolve symlinks for Hydra compatibility
COPY wolf/ubuntu-config/docker-wrapper.sh /usr/local/bin/docker-wrapper.sh
COPY wolf/ubuntu-config/docker-compose-wrapper.sh /usr/local/bin/docker-compose-wrapper.sh
RUN mv /usr/bin/docker /usr/bin/docker.real \
    && mv /usr/local/bin/docker-wrapper.sh /usr/bin/docker \
    && chmod 755 /usr/bin/docker /usr/bin/docker.real \
    && mv /usr/libexec/docker/cli-plugins/docker-compose /usr/libexec/docker/cli-plugins/docker-compose.real \
    && mv /usr/local/bin/docker-compose-wrapper.sh /usr/libexec/docker/cli-plugins/docker-compose \
    && chmod 755 /usr/libexec/docker/cli-plugins/docker-compose /usr/libexec/docker/cli-plugins/docker-compose.real

# ====================================================================
# Install development tools
# ====================================================================
RUN apt-get update && apt-get install -y \
    # Screenshot tools
    scrot \
    # Clipboard tools for X11
    xclip xsel \
    # Git for repository cloning
    git openssh-client \
    # Window management tools
    wmctrl devilspie2 \
    && rm -rf /var/lib/apt/lists/*

# ====================================================================
# Install Node.js for qwen-code
# ====================================================================
RUN curl -fsSL https://deb.nodesource.com/setup_22.x | bash - && \
    apt-get install -y nodejs && \
    rm -rf /var/lib/apt/lists/*

# ====================================================================
# Install qwen-code (Helix's Qwen Code agent CLI)
# ====================================================================
# SECURITY: We build from our fork of qwen-code (github.com/helixml/qwen-code)
# with audited commits and critical bug fixes.
#
# BUILD APPROACH: Copy pre-built qwen-code from local directory
# This is faster during development and ensures we're using our fixes.
# The qwen-code-build directory must be prepared by ./stack build-ubuntu
#
# CACHE BUSTING: QWEN_CODE_HASH build arg changes when qwen-code source changes,
# ensuring Docker rebuilds this layer with the latest code.
ARG QWEN_CODE_HASH=unknown
WORKDIR /opt/qwen-code
COPY qwen-code-build/ ./
# Create global qwen command by symlinking pre-built dist/cli.js
# We don't use 'npm install -g .' because it tries to run prepare scripts
RUN echo "qwen-code commit: ${QWEN_CODE_HASH}" && \
    echo "Fixes: [object Object] error display + shell security disabled" && \
    chmod +x dist/cli.js && \
    ln -sf /opt/qwen-code/dist/cli.js /usr/local/bin/qwen

WORKDIR /

# ====================================================================
# Copy GOW infrastructure scripts
# ====================================================================
# Utils library
COPY wolf/ubuntu-config/gow/bash-lib/utils.sh /opt/gow/bash-lib/utils.sh

# Main scripts
COPY wolf/ubuntu-config/gow/xorg.sh /opt/gow/xorg.sh
COPY wolf/ubuntu-config/gow/dbus.sh /opt/gow/dbus.sh
COPY wolf/ubuntu-config/gow/desktop.sh /opt/gow/desktop.sh
COPY wolf/ubuntu-config/gow/ensure-groups /opt/gow/ensure-groups

# Entrypoint
COPY wolf/ubuntu-config/entrypoint.sh /entrypoint.sh

# Init scripts
COPY wolf/ubuntu-config/cont-init.d/10-setup_user.sh /etc/cont-init.d/10-setup_user.sh
COPY wolf/ubuntu-config/cont-init.d/15-setup_devices.sh /etc/cont-init.d/15-setup_devices.sh
COPY wolf/ubuntu-config/cont-init.d/30-nvidia.sh /etc/cont-init.d/30-nvidia.sh

# Set permissions
RUN chmod +x /entrypoint.sh \
    /opt/gow/xorg.sh \
    /opt/gow/dbus.sh \
    /opt/gow/desktop.sh \
    /opt/gow/ensure-groups \
    /opt/gow/bash-lib/utils.sh \
    /etc/cont-init.d/*.sh

# ====================================================================
# Copy Helix-specific binaries and scripts
# ====================================================================
# Copy Go binaries from build stage
COPY --from=go-build-env /settings-sync-daemon /usr/local/bin/settings-sync-daemon
COPY --from=go-build-env /screenshot-server /usr/local/bin/screenshot-server
COPY --from=go-build-env /revdial-client /usr/local/bin/revdial-client

# Copy Zed binary (built with ./stack build-zed before Docker build)
RUN mkdir -p /zed-build
COPY zed-build/zed /zed-build/zed
RUN chmod +x /zed-build/zed

# Install Zed desktop file and icon for GNOME integration
# The icon is from the Zed source (crates/zed/resources/app-icon-dev.png)
# Generate all standard icon sizes to match GNOME expectations
# IMPORTANT: Use dev.zed.Zed-Dev to match the WM_CLASS from dev builds
COPY wolf/ubuntu-config/zed.desktop /usr/share/applications/dev.zed.Zed-Dev.desktop
RUN chmod 644 /usr/share/applications/dev.zed.Zed-Dev.desktop
COPY zed-build/app-icon.png /usr/share/icons/hicolor/512x512/apps/dev.zed.Zed-Dev.png
RUN for size in 16 24 32 48 64 128 256; do \
        mkdir -p /usr/share/icons/hicolor/${size}x${size}/apps && \
        convert /usr/share/icons/hicolor/512x512/apps/dev.zed.Zed-Dev.png \
            -resize ${size}x${size} \
            /usr/share/icons/hicolor/${size}x${size}/apps/dev.zed.Zed-Dev.png; \
    done && \
    gtk-update-icon-cache -f /usr/share/icons/hicolor && \
    update-desktop-database /usr/share/applications

# Copy Zed startup script and helper scripts
ADD wolf/ubuntu-config/start-zed-helix.sh /usr/local/bin/start-zed-helix.sh
ADD wolf/ubuntu-config/helix-specs-create.sh /usr/local/bin/helix-specs-create.sh
RUN chmod +x /usr/local/bin/start-zed-helix.sh /usr/local/bin/helix-specs-create.sh

# Copy GOW startup script (creates autostart entries and state symlinks)
ADD wolf/ubuntu-config/startup-app.sh /opt/gow/startup.sh
RUN chmod +x /opt/gow/startup.sh

# Copy GNOME dconf settings for Ubuntu appearance (Yaru theme, wallpaper, etc.)
COPY wolf/ubuntu-config/dconf-settings.ini /opt/gow/dconf-settings.ini

# Add Docker group init script (must run AFTER 15-setup_devices.sh which replaces groups)
ADD wolf/ubuntu-config/16-add-docker-group.sh /etc/cont-init.d/16-add-docker-group.sh
RUN chmod 755 /etc/cont-init.d/16-add-docker-group.sh

# Copy devilspie2 window positioning config
RUN mkdir -p /etc/skel/.config/devilspie2
COPY wolf/ubuntu-config/devilspie2/helix-tiling.lua /etc/skel/.config/devilspie2/helix-tiling.lua
RUN chmod 644 /etc/skel/.config/devilspie2/helix-tiling.lua

# Pre-build fontconfig cache (major speedup for first browser launch)
RUN fc-cache -f -v

# ====================================================================
# Final setup
# ====================================================================
# Create required directories
RUN mkdir -p /home/retro/work && \
    chown -R ${UID}:${GID} /home/retro

ENTRYPOINT ["/entrypoint.sh"]
