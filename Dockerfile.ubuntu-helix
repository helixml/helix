# syntax=docker/dockerfile:1.4
# ====================================================================
# Helix Ubuntu GNOME Desktop - Ubuntu 25.10 base with Wayland
# ====================================================================
# Ubuntu 25.10 with GNOME/Mutter running on native Wayland (not Xwayland).
# Same minimal GOW pattern as KDE and Sway for package version consistency.
# Developers can switch between desktops without version differences.
# See: design/2025-12-28-kde-vs-sway-compositor-architecture.md

# ====================================================================
# Go build stage for Helix binaries
# ====================================================================
FROM golang:1.24 AS go-build-env
ARG GO_CODE_HASH=unknown
WORKDIR /app
COPY go.mod go.sum ./
RUN --mount=type=cache,target=/go/pkg/mod go mod download
COPY api ./api
WORKDIR /app/api
RUN --mount=type=cache,target=/go/pkg/mod \
    --mount=type=cache,target=/root/.cache/go-build \
    echo "Go code hash: ${GO_CODE_HASH}" && \
    CGO_ENABLED=0 go build -buildvcs=false -ldflags "-s -w -X main.BuildHash=${GO_CODE_HASH}" -o /screenshot-server ./cmd/screenshot-server && \
    CGO_ENABLED=0 go build -buildvcs=false -ldflags "-s -w" -o /settings-sync-daemon ./cmd/settings-sync-daemon && \
    CGO_ENABLED=0 go build -buildvcs=false -ldflags "-s -w" -o /revdial-client ./cmd/revdial-client

# ====================================================================
# Ubuntu GNOME Desktop - Ubuntu 25.10 base with Wayland
# ====================================================================
# Ubuntu 25.10 uses GNOME 47+ which has excellent Wayland support.
# Supports two modes:
# 1. Nested mode: gnome-shell --wayland --wayland-display=wayland-1 (default)
# 2. Headless mode: gnome-shell --headless + GStreamer bridge (experimental)
#
# The headless bridge uses GStreamer's pipewiresrc + waylandsink for
# zero-copy DMA-BUF transfer from GNOME screen-cast to Wolf.
FROM ubuntu:25.10

# Configure default user and set env (from GOW base-app)
ENV \
    PUID=1000 \
    PGID=1000 \
    UMASK=000 \
    UNAME="retro" \
    HOME="/home/retro" \
    TZ="Europe/London" \
    DEBIAN_FRONTEND=noninteractive \
    NEEDRESTART_SUSPEND=1

ARG TARGETARCH TARGETVARIANT

# Install GOW base requirements + GNOME packages
ARG GOSU_VERSION=1.14

ARG CORE_PACKAGES=" \
    wget \
    curl \
    jq \
    fuse \
    libnss3 \
    ca-certificates \
    dbus \
    flatpak \
    locales \
    software-properties-common \
    gpg-agent \
    sudo \
    bc \
    "

ARG DE_PACKAGES=" \
    ubuntu-desktop-minimal \
    gnome-shell \
    gnome-session \
    mutter \
    gnome-settings-daemon \
    nautilus \
    gnome-terminal \
    gnome-control-center \
    gnome-tweaks \
    gnome-keyring \
    libsecret-tools \
    yaru-theme-gtk \
    yaru-theme-icon \
    ubuntu-wallpapers \
    fonts-ubuntu \
    gnome-shell-extension-ubuntu-dock \
    dconf-cli \
    xdg-utils \
    pipewire \
    pipewire-audio \
    wireplumber \
    libpipewire-0.3-0 \
    gnome-remote-desktop \
    gstreamer1.0-pipewire \
    gstreamer1.0-plugins-base \
    gstreamer1.0-plugins-good \
    gstreamer1.0-gl \
    wl-clipboard \
    mutter-dev-bin \
    "

# Install base packages, PPAs, and GNOME
RUN <<_INSTALL_BASE
  set -e

  echo "**** Update apt database ****"
  apt-get update

  echo "**** Install base packages ****"
  apt-get install -y --no-install-recommends $CORE_PACKAGES

  echo "**** Install gosu (from GOW) ****"
  GOSU_ARCH="${TARGETARCH:-amd64}"
  wget --progress=dot:giga \
      -O /usr/bin/gosu \
      "https://github.com/tianon/gosu/releases/download/${GOSU_VERSION}/gosu-${GOSU_ARCH}"
  chmod +x /usr/bin/gosu
  gosu nobody true && echo "gosu working!"

  echo "**** Setup Firefox PPA ****"
  add-apt-repository -y ppa:mozillateam/ppa

  echo "**** Configure APT pins ****"
  cat > /etc/apt/preferences.d/mozilla-firefox << 'PINEOF'
Package: *
Pin: release o=LP-PPA-mozillateam
Pin-Priority: 1001
PINEOF

  apt-get update

  echo "**** Install GNOME Desktop (Wayland session) ****"
  apt-get install -y $DE_PACKAGES firefox libavcodec-extra

  echo "=== Installed GNOME Versions ==="
  dpkg -l | grep -E "gnome-shell|mutter" || true
  gnome-shell --version || echo "gnome-shell not found yet"

  echo "**** Cleanup ****"
  apt autoremove -y
  apt clean
  rm -rf /var/lib/apt/lists/* /var/tmp/* /tmp/*

_INSTALL_BASE

# WirePlumber configuration to disable stream suspension
# PipeWire/WirePlumber suspends streams after 5 seconds of "inactivity" by default.
# This causes ScreenCast video streams to stop producing frames, breaking Wolf video capture.
# See: https://bbs.archlinux.org/viewtopic.php?id=309630
#
# Solution: Change the default timeout in suspend-node.lua from 5 seconds to 1 day (86400 seconds)
# We can't remove or disable the component because policy.node depends on hooks.node.suspend
RUN <<_WIREPLUMBER_CONFIG
echo "=== Fixing WirePlumber suspension timeout ==="

# Modify suspend-node.lua to use 1 day timeout instead of 5 seconds
# Find the line that sets the default timeout (5) and change it to 86400
if [ -f /usr/share/wireplumber/scripts/node/suspend-node.lua ]; then
    # The script has: tonumber(node.properties["session.suspend-timeout-seconds"]) or 5
    # Change the default from 5 to 86400 (1 day)
    # Use simple pattern matching the end of line to avoid escaping issues
    sed -i 's/) or 5$/) or 86400/' /usr/share/wireplumber/scripts/node/suspend-node.lua

    # Verify the change
    echo "Modified suspend-node.lua - checking for 86400:"
    grep -n "86400" /usr/share/wireplumber/scripts/node/suspend-node.lua || echo "WARNING: 86400 not found!"
fi

echo "=== WirePlumber suspension fix applied (86400s timeout) ==="
_WIREPLUMBER_CONFIG

# Create retro user (from GOW base-app)
# Ubuntu 25.10 base image has existing user/group with UID/GID 1000, so we remove first
RUN <<_CREATE_USER
  set -e
  # Remove existing user with UID 1000 if present
  EXISTING_USER=$(getent passwd 1000 | cut -d: -f1) || true
  if [ -n "$EXISTING_USER" ]; then
    userdel -r "$EXISTING_USER" 2>/dev/null || userdel "$EXISTING_USER" || true
  fi
  # Remove existing group with GID 1000 if present
  EXISTING_GROUP=$(getent group 1000 | cut -d: -f1) || true
  if [ -n "$EXISTING_GROUP" ]; then
    groupdel "$EXISTING_GROUP" 2>/dev/null || true
  fi
  # Create retro user/group
  groupadd -g 1000 retro
  useradd -m -u 1000 -g 1000 -s /bin/bash retro
  mkdir -p /home/retro
  chown -R retro:retro /home/retro
_CREATE_USER

# GOW utilities and entrypoint (minimal version)
RUN mkdir -p /opt/gow/bash-lib /opt/gow/startup.d /etc/cont-init.d

# GOW utils.sh (minimal implementation)
COPY <<'_GOW_UTILS' /opt/gow/bash-lib/utils.sh
#!/bin/bash
gow_log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*"
}
export -f gow_log
_GOW_UTILS

# GOW user setup init script
COPY <<'_USER_INIT' /etc/cont-init.d/10-setup_user.sh
#!/bin/bash
echo "**** Configure default user ****"
echo "Setting default user uid=$(id -u ${UNAME}) gid=$(id -g ${UNAME})"
echo "Setting umask to ${UMASK}"
umask "${UMASK}"
echo "Ensure ${UNAME} home directory is writable"
chown -R "${UNAME}:${UNAME}" "/home/${UNAME}" 2>/dev/null || true
echo "Ensure XDG_RUNTIME_DIR is writable"
mkdir -p "${XDG_RUNTIME_DIR:-/run/user/1000}"
chown -R "${UNAME}:${UNAME}" "${XDG_RUNTIME_DIR:-/run/user/1000}" 2>/dev/null || true
chmod 700 "${XDG_RUNTIME_DIR:-/run/user/1000}" 2>/dev/null || true
_USER_INIT

# GOW entrypoint
COPY <<'_ENTRYPOINT' /entrypoint.sh
#!/usr/bin/env bash
set -e
source /opt/gow/bash-lib/utils.sh
if [ "$(id -u)" = "0" ]; then
    for init_script in /etc/cont-init.d/*.sh ; do
        gow_log
        gow_log "[ ${init_script}: executing... ]"
        source "${init_script}"
    done
fi
if [ -n "${@:-}" ]; then
    /bin/bash -c "$@"
    exit $?
fi
gow_log "Launching the container's startup script as user '${UNAME}'"
chmod +x /opt/gow/startup.sh 2>/dev/null || true
exec gosu "${UNAME}" ${STARTUP_SCRIPT:-/opt/gow/startup.sh}
_ENTRYPOINT
RUN chmod +x /entrypoint.sh /etc/cont-init.d/*.sh /opt/gow/bash-lib/utils.sh

ENTRYPOINT ["/entrypoint.sh"]

# GOW fixes (locale + bwrap)
RUN <<_FIXES
  set -e
  locale-gen en_US.UTF-8
  chmod u+s /usr/bin/bwrap 2>/dev/null || true
_FIXES

# GNOME/Wayland environment variables
ENV LANG=en_US.UTF-8 \
    LC_ALL=en_US.UTF-8 \
    XDG_SESSION_TYPE=wayland \
    XDG_CURRENT_DESKTOP=GNOME \
    QT_QPA_PLATFORM=wayland \
    GDK_BACKEND=wayland \
    CLUTTER_BACKEND=wayland \
    SDL_VIDEODRIVER=wayland \
    MUTTER_ALLOW_NESTED=1

# GOW dbus init script
COPY <<_DBUS_INIT /etc/cont-init.d/99-startdbus.sh
#!/bin/bash
service dbus start 2>/dev/null || true
_DBUS_INIT
RUN chmod 755 /etc/cont-init.d/99-startdbus.sh

# Disable systemd-logind (not available in containers)
# GNOME session manager tries to connect to systemd-logind for session management
RUN for file in $(find /usr -type f -iname "*login1*" 2>/dev/null); do \
    mv -v "$file" "$file.back" 2>/dev/null || true; \
    done

# ====================================================================
# Helix additions (same pattern as KDE/Sway)
# ====================================================================

# RADV/AMD debug options for GPU crash prevention
ENV RADV_DEBUG=hang
ENV AMD_DEBUG=sync_compile,check_vm

# Passwordless sudo
RUN echo "%sudo ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers && \
    echo "retro ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers && \
    echo "user ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# Docker CLI
RUN apt-get update \
    && apt-get install -y --no-install-recommends gnupg ca-certificates curl lsb-release \
    && install -m 0755 -d /etc/apt/keyrings \
    && curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg \
    && chmod a+r /etc/apt/keyrings/docker.gpg \
    && echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" > /etc/apt/sources.list.d/docker.list \
    && apt-get update \
    && apt-get install -y docker-ce-cli docker-compose-plugin \
    && rm -rf /var/lib/apt/lists/*

# Docker wrappers for Hydra compatibility
COPY wolf/ubuntu-config/docker-wrapper.sh /usr/local/bin/docker-wrapper.sh
COPY wolf/ubuntu-config/docker-compose-wrapper.sh /usr/local/bin/docker-compose-wrapper.sh
RUN mv /usr/bin/docker /usr/bin/docker.real \
    && mv /usr/local/bin/docker-wrapper.sh /usr/bin/docker \
    && chmod 755 /usr/bin/docker /usr/bin/docker.real \
    && mv /usr/libexec/docker/cli-plugins/docker-compose /usr/libexec/docker/cli-plugins/docker-compose.real \
    && mv /usr/local/bin/docker-compose-wrapper.sh /usr/libexec/docker/cli-plugins/docker-compose \
    && chmod 755 /usr/libexec/docker/cli-plugins/docker-compose /usr/libexec/docker/cli-plugins/docker-compose.real

# Utilities
RUN apt-get update && apt-get install -y \
    lsof libjpeg-turbo8 \
    evtest evemu-tools \
    bash git openssh-client \
    fonts-noto-color-emoji fonts-dejavu-core \
    imagemagick \
    kitty \
    scrot xclip x11-utils \
    grim slurp \
    gnome-screenshot \
    && rm -rf /var/lib/apt/lists/*

# Helix background
RUN mkdir -p /usr/share/backgrounds && \
    wget -O /usr/share/backgrounds/helix-logo.png https://helix.ml/assets/helix-logo.png

# Node.js 20 (for Qwen Code)
RUN apt-get update && \
    apt-get install -y ca-certificates curl gnupg git && \
    mkdir -p /etc/apt/keyrings && \
    curl -fsSL https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key | gpg --dearmor -o /etc/apt/keyrings/nodesource.gpg && \
    echo "deb [signed-by=/etc/apt/keyrings/nodesource.gpg] https://deb.nodesource.com/node_20.x nodistro main" > /etc/apt/sources.list.d/nodesource.list && \
    apt-get update && \
    apt-get install -y nodejs && \
    rm -rf /var/lib/apt/lists/*

# Qwen Code
ARG QWEN_CODE_HASH=unknown
WORKDIR /opt/qwen-code
COPY qwen-code-build/ ./
RUN echo "qwen-code commit: ${QWEN_CODE_HASH}" && \
    chmod +x dist/cli.js && \
    ln -sf /opt/qwen-code/dist/cli.js /usr/local/bin/qwen

WORKDIR /

# Helix startup script (GNOME Wayland session)
COPY <<'_STARTUP' /opt/gow/startup.sh
#!/bin/bash -e
# GOW startup script for Helix Desktop (Ubuntu GNOME Wayland)
source /opt/gow/bash-lib/utils.sh

gow_log "[start] Starting Helix Desktop (Ubuntu GNOME Wayland)..."

# Create symlink to Zed binary if not exists
if [ -f /zed-build/zed ] && [ ! -f /usr/local/bin/zed ]; then
    sudo ln -sf /zed-build/zed /usr/local/bin/zed
    gow_log "[start] Created symlink: /usr/local/bin/zed -> /zed-build/zed"
fi

# Workspace setup (same pattern as KDE/Sway)
if [ -z "$WORKSPACE_DIR" ]; then
    gow_log "[start] FATAL: WORKSPACE_DIR environment variable not set"
    exit 1
fi
if [ ! -d "$WORKSPACE_DIR" ]; then
    gow_log "[start] FATAL: WORKSPACE_DIR does not exist: $WORKSPACE_DIR"
    exit 1
fi
if [ ! -d /home/retro/work ]; then
    gow_log "[start] FATAL: /home/retro/work bind mount not present"
    exit 1
fi
sudo chown retro:retro "$WORKSPACE_DIR"
sudo chown retro:retro /home/retro/work
gow_log "[start] Workspace mounted at both $WORKSPACE_DIR and /home/retro/work"

# Create Zed config symlinks
WORK_DIR=/home/retro/work
ZED_STATE_DIR=$WORK_DIR/.zed-state
cd /home/retro/work

mkdir -p $ZED_STATE_DIR/config $ZED_STATE_DIR/local-share $ZED_STATE_DIR/cache

rm -rf ~/.config/zed && mkdir -p ~/.config && ln -sf $ZED_STATE_DIR/config ~/.config/zed
rm -rf ~/.local/share/zed && mkdir -p ~/.local/share && ln -sf $ZED_STATE_DIR/local-share ~/.local/share/zed
rm -rf ~/.cache/zed && mkdir -p ~/.cache && ln -sf $ZED_STATE_DIR/cache ~/.cache/zed

gow_log "[start] Zed state symlinks created"

# Configure fontconfig for grayscale antialiasing
mkdir -p ~/.config/fontconfig
cat > ~/.config/fontconfig/fonts.conf << 'FONTCONFIG_EOF'
<?xml version="1.0"?>
<!DOCTYPE fontconfig SYSTEM "fonts.dtd">
<fontconfig>
  <match target="font">
    <edit name="rgba" mode="assign"><const>none</const></edit>
    <edit name="antialias" mode="assign"><bool>true</bool></edit>
    <edit name="hinting" mode="assign"><bool>true</bool></edit>
    <edit name="hintstyle" mode="assign"><const>hintslight</const></edit>
  </match>
</fontconfig>
FONTCONFIG_EOF

# Configure Qwen Code session persistence
export QWEN_DATA_DIR=$WORK_DIR/.qwen-state
mkdir -p $QWEN_DATA_DIR
rm -rf ~/.qwen && ln -sf $QWEN_DATA_DIR ~/.qwen
gow_log "[start] Qwen data directory set: QWEN_DATA_DIR=$QWEN_DATA_DIR"

# Start RevDial client
if [ -n "$HELIX_API_BASE_URL" ] && [ -n "$HELIX_SESSION_ID" ] && [ -n "$USER_API_TOKEN" ]; then
    REVDIAL_SERVER="${HELIX_API_BASE_URL}/api/v1/revdial"
    RUNNER_ID="sandbox-${HELIX_SESSION_ID}"
    gow_log "[start] Starting RevDial client..."
    /usr/local/bin/revdial-client \
        -server "$REVDIAL_SERVER" \
        -runner-id "$RUNNER_ID" \
        -token "$USER_API_TOKEN" \
        -local "localhost:9876" \
        >> /tmp/revdial-client.log 2>&1 &
    gow_log "[start] RevDial client started (PID: $!)"
fi

# Disable IBus Input Method Framework
# IBus can interfere with keyboard input in remote streaming environments
# This fixes Shift key and other modifier keys not working properly
export GTK_IM_MODULE=gtk-im-context-simple
export QT_IM_MODULE=gtk-im-context-simple
export XMODIFIERS=@im=none
gow_log "[start] IBus disabled (using simple input context)"

# GNOME Wayland session setup
export GAMESCOPE_WIDTH=${GAMESCOPE_WIDTH:-1920}
export GAMESCOPE_HEIGHT=${GAMESCOPE_HEIGHT:-1080}
export GAMESCOPE_REFRESH=${GAMESCOPE_REFRESH:-60}

# Display scaling support
# HELIX_DISPLAY_SCALE (e.g., "1.5" or "2") sets the scale factor for GTK/Qt apps
# GNOME Shell's --virtual-monitor sets the compositor resolution
if [ -n "$HELIX_DISPLAY_SCALE" ] && [ "$HELIX_DISPLAY_SCALE" != "1" ]; then
    export GDK_SCALE=$HELIX_DISPLAY_SCALE
    export GDK_DPI_SCALE=1  # Prevent double-scaling with GDK_SCALE
    export QT_SCALE_FACTOR=$HELIX_DISPLAY_SCALE
    gow_log "[start] Display scaling enabled: ${HELIX_DISPLAY_SCALE}x"
else
    gow_log "[start] Display scaling: 1x (default)"
fi

# Enable nested mode for Mutter (running inside Wolf's compositor)
export MUTTER_ALLOW_NESTED=1

# Save Wolf's Wayland display (wayland-1) before we change it for client apps
WOLF_WAYLAND_DISPLAY=$WAYLAND_DISPLAY

# Create GNOME start script
# Note: Using non-quoted heredoc so $WOLF_WAYLAND_DISPLAY is captured at script creation
cat <<GNOME_EOF > $XDG_RUNTIME_DIR/start_gnome
#!/bin/bash
source /opt/gow/bash-lib/utils.sh

# Set GNOME environment
export XDG_CURRENT_DESKTOP=GNOME
export XDG_SESSION_DESKTOP=gnome
export XDG_SESSION_TYPE=wayland
export DESKTOP_SESSION=gnome

# Ensure IBus is disabled (fixes keyboard input issues with modifier keys)
export GTK_IM_MODULE=gtk-im-context-simple
export QT_IM_MODULE=gtk-im-context-simple
export XMODIFIERS=@im=none

# Display scaling
# HELIX_ZOOM_LEVEL is a percentage (100, 150, 200) set by wolf_executor
# Convert to scale factor: 100→1, 150→1.5, 200→2
#
# Scaling works at TWO levels:
# 1. Compositor level: MUTTER_DEBUG_DUMMY_MONITOR_SCALES sets the virtual monitor's scale
#    - This makes GNOME Shell render at the scaled resolution internally
#    - Required for proper DPI scaling of the entire desktop
# 2. Client app level: GDK_SCALE/QT_SCALE_FACTOR for GTK/Qt applications
#    - These tell individual apps to render at the correct scale
#
# Reference: https://wiki.gnome.org/HowDoI/HiDpi
ZOOM_LEVEL="\${HELIX_ZOOM_LEVEL:-100}"
if [ "\$ZOOM_LEVEL" -gt 100 ]; then
    # Calculate scale factor from zoom percentage (e.g., 200% → 2)
    HELIX_SCALE_FACTOR=\$(echo "scale=1; \$ZOOM_LEVEL / 100" | bc)

    # Set Mutter's virtual monitor scale (compositor-level scaling)
    # This env var tells Mutter to create the virtual monitor with this scale factor
    # Works with both --nested and --headless modes
    export MUTTER_DEBUG_DUMMY_MONITOR_SCALES=\$HELIX_SCALE_FACTOR

    # Client app scaling (GTK and Qt applications)
    export GDK_SCALE=\$HELIX_SCALE_FACTOR
    export GDK_DPI_SCALE=1  # Prevent double-scaling with GDK_SCALE
    export QT_SCALE_FACTOR=\$HELIX_SCALE_FACTOR

    gow_log "[start] Display scaling: \${HELIX_SCALE_FACTOR}x (MUTTER_DEBUG_DUMMY_MONITOR_SCALES=\$HELIX_SCALE_FACTOR, GDK_SCALE=\$HELIX_SCALE_FACTOR)"
else
    HELIX_SCALE_FACTOR=""
    gow_log "[start] Display scaling: 1x (default)"
fi

# GNOME 49 Mutter SDK (--devkit) Architecture:
# =============================================
# Two video source modes:
# 1. "wayland" (default): mutter-devkit renders to Wolf's Wayland display
#    - gnome-shell --devkit spawns mutter-devkit
#    - mutter-devkit outputs to WAYLAND_DISPLAY (Wolf's display)
#    - Wolf uses waylanddisplaysrc to capture
#
# 2. "pipewire": Wolf uses pipewiresrc to read directly from PipeWire
#    - gnome-shell --devkit runs without a display target
#    - Container creates ScreenCast session via D-Bus
#    - Container reports PipeWire node ID to Wolf via API
#    - Wolf uses pipewiresrc to capture
#
# Mode is set by WOLF_VIDEO_SOURCE_MODE environment variable

VIDEO_SOURCE_MODE="\${WOLF_VIDEO_SOURCE_MODE:-wayland}"
gow_log "[start] Video source mode: \$VIDEO_SOURCE_MODE"

if [ "\$VIDEO_SOURCE_MODE" = "pipewire" ]; then
    # PipeWire mode: mutter-devkit has nowhere to render (which is fine)
    unset WAYLAND_DISPLAY
    gow_log "[start] PipeWire mode: WAYLAND_DISPLAY unset (using pipewiresrc)"
else
    # Wayland mode: keep Wolf's display for mutter-devkit to render to
    gow_log "[start] Wayland mode: WAYLAND_DISPLAY=$WOLF_WAYLAND_DISPLAY (mutter-devkit renders here)"
fi

gow_log "[start] Starting PipeWire + WirePlumber"
pipewire &
sleep 0.5
wireplumber &
sleep 0.5

# Enable Just Perfection extension and hide screen recording indicator
# This MUST be done before gnome-shell starts so the extension is loaded
# The extension hides the ScreenCast "stop" button that would crash Wolf if clicked
gow_log "[start] Enabling Just Perfection extension to hide screen recording indicator..."
gsettings set org.gnome.shell enabled-extensions "['just-perfection-desktop@just-perfection']"
gsettings set org.gnome.shell.extensions.just-perfection screen-recording-indicator false
gsettings set org.gnome.shell.extensions.just-perfection screen-sharing-indicator false
gow_log "[start] Just Perfection extension configured"

# Enable fractional scaling experimental feature (needed for non-integer scales like 1.5)
# This must be set before gnome-shell starts to take effect
if [ -n "\$HELIX_SCALE_FACTOR" ]; then
    gow_log "[start] Enabling fractional scaling experimental feature..."
    gsettings set org.gnome.mutter experimental-features "['scale-monitor-framebuffer']"
fi

# Start Helix services - these need wayland-0 (Mutter's client socket)
if [ -n "\$HELIX_API_BASE_URL" ] && [ -n "\$USER_API_TOKEN" ]; then
  gow_log "[start] Starting settings-sync-daemon..."
  WAYLAND_DISPLAY=wayland-0 XDG_CURRENT_DESKTOP=GNOME /usr/local/bin/settings-sync-daemon >> /tmp/settings-sync-daemon.log 2>&1 &
fi

if [ -x /usr/local/bin/screenshot-server ]; then
  gow_log "[start] Starting screenshot server (includes D-Bus session + input bridge)..."
  # Screenshot server handles:
  # - HTTP API: /screenshot, /clipboard, /keyboard-state, /keyboard-reset, /upload
  # - GNOME: Creates RemoteDesktop+ScreenCast sessions, reports PipeWire node to Wolf
  # - Input bridge: Receives events from Wolf, injects via D-Bus NotifyPointer*/NotifyKeyboard*
  WAYLAND_DISPLAY=wayland-0 XDG_CURRENT_DESKTOP=GNOME /usr/local/bin/screenshot-server >> /tmp/screenshot-server.log 2>&1 &
fi

# Verify display scale after GNOME Shell is ready (if scaling is enabled)
# MUTTER_DEBUG_DUMMY_MONITOR_SCALES sets the scale at startup, this just logs the result
if [ -n "\$HELIX_SCALE_FACTOR" ]; then
  (
    gow_log "[start] Waiting to verify display scale..."
    for i in \$(seq 1 30); do
      if pgrep -x gnome-shell > /dev/null 2>&1; then
        sleep 2
        break
      fi
      sleep 1
    done

    # Log the current display configuration for debugging
    STATE=\$(gdbus call --session \\
        --dest org.gnome.Mutter.DisplayConfig \\
        --object-path /org/gnome/Mutter/DisplayConfig \\
        --method org.gnome.Mutter.DisplayConfig.GetCurrentState 2>&1 || echo "D-Bus call failed")

    gow_log "[start] Display config (MUTTER_DEBUG_DUMMY_MONITOR_SCALES=\$HELIX_SCALE_FACTOR): \${STATE:0:400}"
  ) &
fi

# Launch Zed after GNOME Shell is ready - it needs wayland-0
if [ -x /zed-build/zed ]; then
  (
    gow_log "[start] Waiting for GNOME Shell to start before launching Zed..."
    for i in \$(seq 1 60); do
      if pgrep -x gnome-shell > /dev/null 2>&1; then
        gow_log "[start] gnome-shell detected, waiting 2 more seconds for initialization..."
        sleep 2
        break
      fi
      sleep 1
    done
    gow_log "[start] Launching Zed (WAYLAND_DISPLAY=wayland-0)..."
    WAYLAND_DISPLAY=wayland-0 /usr/local/bin/start-zed-helix.sh
  ) &
fi

gow_log "[start] Virtual monitor: ${GAMESCOPE_WIDTH}x${GAMESCOPE_HEIGHT}@${GAMESCOPE_REFRESH}"

# GNOME 49 supports two modes:
# - PipeWire mode (--headless): No display output, Wolf uses pipewiresrc to capture from PipeWire
# - Wayland mode (--nested): Outputs to Wolf's Wayland display, Wolf uses waylanddisplaysrc
#
# --virtual-monitor WxH@R creates a virtual display at the specified resolution

if [ "\$VIDEO_SOURCE_MODE" = "pipewire" ]; then
    gow_log "[start] Starting GNOME Shell in HEADLESS mode (PipeWire capture)"
    # --headless: No display output - Wolf captures via pipewiresrc from ScreenCast
    # --unsafe-mode: Allow screenshot-server to use org.gnome.Shell.Screenshot D-Bus API
    #                (GNOME 41+ restricts this API to whitelisted callers only)
    gnome-shell --headless --unsafe-mode --virtual-monitor ${GAMESCOPE_WIDTH}x${GAMESCOPE_HEIGHT}@${GAMESCOPE_REFRESH}
else
    gow_log "[start] Starting GNOME Shell in NESTED mode (Wayland capture)"
    # --nested: Outputs to Wolf's Wayland display - Wolf captures via waylanddisplaysrc
    # --unsafe-mode: Allow screenshot-server to use org.gnome.Shell.Screenshot D-Bus API
    gnome-shell --nested --unsafe-mode --virtual-monitor ${GAMESCOPE_WIDTH}x${GAMESCOPE_HEIGHT}@${GAMESCOPE_REFRESH}
fi
GNOME_EOF

chmod +x $XDG_RUNTIME_DIR/start_gnome

dbus-run-session -- $XDG_RUNTIME_DIR/start_gnome
_STARTUP
RUN chmod +x /opt/gow/startup.sh

# Helix helper scripts
ADD wolf/ubuntu-config/start-zed-helix.sh /usr/local/bin/start-zed-helix.sh
ADD wolf/ubuntu-config/helix-specs-create.sh /usr/local/bin/helix-specs-create.sh
ADD wolf/ubuntu-config/start-gnome-bridge.sh /usr/local/bin/start-gnome-bridge.sh
ADD wolf/ubuntu-config/start-pipewire-screencast.sh /opt/gow/start-pipewire-screencast.sh
ADD wolf/shared/helix-git-hooks.sh /usr/local/bin/helix-git-hooks.sh
RUN chmod 755 /usr/local/bin/start-zed-helix.sh /usr/local/bin/helix-specs-create.sh /usr/local/bin/start-gnome-bridge.sh /usr/local/bin/helix-git-hooks.sh /opt/gow/start-pipewire-screencast.sh

# Docker group init script
ADD wolf/ubuntu-config/16-add-docker-group.sh /etc/cont-init.d/16-add-docker-group.sh
RUN chmod 755 /etc/cont-init.d/16-add-docker-group.sh

# Workspace README
RUN mkdir -p /opt/helix
ADD WORKDIR_README.md /opt/helix/WORKDIR_README.md

# Helix Go binaries
COPY --from=go-build-env /screenshot-server /usr/local/bin/screenshot-server
COPY --from=go-build-env /settings-sync-daemon /usr/local/bin/settings-sync-daemon
COPY --from=go-build-env /revdial-client /usr/local/bin/revdial-client

# Zed binary
RUN mkdir -p /zed-build
COPY zed-build/zed /zed-build/zed
RUN chmod +x /zed-build/zed

# Zed desktop file and icon
COPY wolf/ubuntu-config/zed.desktop /usr/share/applications/dev.zed.Zed-Dev.desktop
RUN chmod 644 /usr/share/applications/dev.zed.Zed-Dev.desktop
COPY zed-build/app-icon.png /usr/share/icons/hicolor/512x512/apps/dev.zed.Zed-Dev.png
RUN for size in 16 24 32 48 64 128 256; do \
        mkdir -p /usr/share/icons/hicolor/${size}x${size}/apps && \
        convert /usr/share/icons/hicolor/512x512/apps/dev.zed.Zed-Dev.png \
            -resize ${size}x${size} \
            /usr/share/icons/hicolor/${size}x${size}/apps/dev.zed.Zed-Dev.png; \
    done && \
    gtk-update-icon-cache -f /usr/share/icons/hicolor 2>/dev/null || true && \
    update-desktop-database /usr/share/applications 2>/dev/null || true

# AI agent privacy configs
RUN mkdir -p /home/retro/.qwen && \
    echo '{"privacy":{"usageStatisticsEnabled":false},"general":{"disableAutoUpdate":true,"disableUpdateNag":true}}' > /home/retro/.qwen/settings.json

RUN mkdir -p /home/retro/.gemini && \
    echo '{"privacy":{"usageStatisticsEnabled":false},"general":{"disableAutoUpdate":true,"disableUpdateNag":true}}' > /home/retro/.gemini/settings.json

RUN mkdir -p /home/retro/.claude && \
    echo '{"env":{"CLAUDE_CODE_DISABLE_NONESSENTIAL_TRAFFIC":"1","DISABLE_TELEMETRY":"1","DISABLE_ERROR_REPORTING":"1","DISABLE_AUTOUPDATER":"1"}}' > /home/retro/.claude/settings.json

RUN mkdir -p /home/retro/.config/zed && \
    echo '{"telemetry":{"diagnostics":false,"metrics":false}}' > /home/retro/.config/zed/settings.json

ENV GEMINI_TELEMETRY_ENABLED=false \
    CLAUDE_CODE_DISABLE_NONESSENTIAL_TRAFFIC=1 \
    DISABLE_TELEMETRY=1 \
    DISABLE_ERROR_REPORTING=1 \
    DISABLE_AUTOUPDATER=1 \
    NODE_TLS_REJECT_UNAUTHORIZED=0 \
    ZED_HTTP_INSECURE_TLS=1

RUN git config --system http.sslVerify false

# Just Perfection extension - hide screen recording indicator in GNOME 49
# When PipeWire ScreenCast is active, GNOME shows a recording indicator with a "stop" button.
# Clicking this button terminates the ScreenCast session and crashes the stream for everyone.
# This extension hides the indicator to prevent accidental session termination.
RUN mkdir -p /usr/share/gnome-shell/extensions/just-perfection-desktop@just-perfection
COPY wolf/ubuntu-config/gnome-extensions/just-perfection-desktop@just-perfection.zip /tmp/
RUN unzip -o /tmp/just-perfection-desktop@just-perfection.zip -d /usr/share/gnome-shell/extensions/just-perfection-desktop@just-perfection && \
    rm /tmp/just-perfection-desktop@just-perfection.zip && \
    # Fix permissions (metadata.json in zip has 600, needs to be readable by retro user)
    chmod -R a+rX /usr/share/gnome-shell/extensions/just-perfection-desktop@just-perfection && \
    # Compile the extension's schema for system-wide use
    cp /usr/share/gnome-shell/extensions/just-perfection-desktop@just-perfection/schemas/org.gnome.shell.extensions.just-perfection.gschema.xml /usr/share/glib-2.0/schemas/ && \
    glib-compile-schemas /usr/share/glib-2.0/schemas/

# Pre-build fontconfig cache (major speedup for first browser launch)
RUN fc-cache -f -v

RUN chown -R 1000:1000 /home/retro/.qwen \
                        /home/retro/.gemini \
                        /home/retro/.claude \
                        /home/retro/.config/zed

# ====================================================================
# Chrome DevTools MCP Server
# ====================================================================
# Install Google Chrome and chrome-devtools-mcp for AI agent browser control
# See: https://developer.chrome.com/blog/chrome-devtools-mcp
# Note: Most Chrome deps are already installed with GNOME, just need Chrome itself

RUN apt-get update && \
    wget -q -O /tmp/google-chrome.deb https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb && \
    dpkg -i /tmp/google-chrome.deb || apt-get install -f -y && \
    rm /tmp/google-chrome.deb && \
    rm -rf /var/lib/apt/lists/* && \
    # Configure Chrome enterprise policies (suppress all first-run dialogs)
    mkdir -p /etc/opt/chrome/policies/managed && \
    echo '{ \
      "DefaultBrowserSettingEnabled": false, \
      "MetricsReportingEnabled": false, \
      "BrowserSignin": 0, \
      "PromotionalTabsEnabled": false, \
      "ShowFirstRunBubble": false, \
      "WelcomePageOnOSUpgradeEnabled": false, \
      "SyncDisabled": true, \
      "ImportBookmarks": false, \
      "ImportHistory": false, \
      "ImportSavedPasswords": false, \
      "ImportSearchEngine": false, \
      "RestoreOnStartup": 5, \
      "PasswordManagerEnabled": true \
    }' > /etc/opt/chrome/policies/managed/helix.json && \
    # Create master preferences to skip first run and welcome page
    mkdir -p /opt/google/chrome && \
    echo '{ \
      "distribution": { \
        "skip_first_run_ui": true, \
        "suppress_first_run_default_browser_prompt": true, \
        "do_not_create_desktop_shortcut": true, \
        "do_not_create_quick_launch_shortcut": true, \
        "do_not_create_taskbar_shortcut": true, \
        "do_not_launch_chrome": true, \
        "do_not_register_for_update_launch": true, \
        "make_chrome_default": false, \
        "make_chrome_default_for_user": false, \
        "suppress_first_run_bubble": true, \
        "import_bookmarks": false, \
        "import_history": false, \
        "import_home_page": false, \
        "import_search_engine": false \
      }, \
      "browser": { \
        "check_default_browser": false, \
        "show_home_button": false \
      }, \
      "sync_promo": { \
        "show_on_first_run_allowed": false \
      }, \
      "first_run_tabs": ["about:blank"] \
    }' > /opt/google/chrome/master_preferences && \
    # Patch Chrome desktop file to bypass keyring (prevents password prompt in containers)
    sed -i 's|^Exec=/usr/bin/google-chrome-stable|Exec=/usr/bin/google-chrome-stable --password-store=basic|' /usr/share/applications/google-chrome.desktop

# Pre-create Chrome "First Run" sentinel file to skip first-run dialogs
# Chrome checks for this file to determine if it's the first launch
RUN mkdir -p /etc/skel/.config/google-chrome && \
    touch /etc/skel/.config/google-chrome/"First Run" && \
    # Also create Default profile directory with minimal preferences
    mkdir -p /etc/skel/.config/google-chrome/Default && \
    echo '{"browser":{"has_seen_welcome_page":true},"distribution":{"skip_first_run_ui":true}}' \
      > /etc/skel/.config/google-chrome/Default/Preferences

# Install chrome-devtools-mcp globally
RUN npm install -g chrome-devtools-mcp@latest

# Chrome MCP server configuration for headless mode
ENV CHROME_DEVTOOLS_MCP_HEADLESS=true \
    CHROME_DEVTOOLS_MCP_VIEWPORT=1920x1080
