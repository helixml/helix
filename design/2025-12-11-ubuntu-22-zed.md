# Building Zed for Ubuntu 22.04 Compatibility

**Date:** 2025-12-11
**Status:** Implemented
**Branch:** `feature/ubuntu-desktop`

## Problem

The Zed binary built on the host system (Ubuntu 25.04) cannot run on Ubuntu 22.04 containers due to glibc version mismatch:

```
/zed-build/zed: /lib/x86_64-linux-gnu/libc.so.6: version `GLIBC_2.38' not found (required by /zed-build/zed)
/zed-build/zed: /lib/x86_64-linux-gnu/libc.so.6: version `GLIBC_2.39' not found (required by /zed-build/zed)
```

**Root Cause:**
- Host system (Ubuntu 25.04) has glibc 2.41
- Zed binary compiled on host links against glibc 2.38/2.39 symbols
- Ubuntu 22.04 container only has glibc 2.35
- glibc is forward-compatible but NOT backward-compatible

## Solution

Build Zed inside an Ubuntu 22.04 Docker container. This produces a binary linked against glibc 2.35, which works on:
- Ubuntu 22.04 (native) - Ubuntu desktop container
- Ubuntu 25.04 (forward-compatible) - Sway container

## Implementation

### 1. Created `Dockerfile.zed-build`

A Docker image with all Zed build dependencies on Ubuntu 22.04:

```dockerfile
FROM ubuntu:22.04

# Build tools
build-essential, clang, cmake, mold, pkg-config

# Libraries
libssl-dev, libzstd-dev, libsqlite3-dev, libvulkan-dev
libwayland-dev, libxkbcommon-dev
libxcb-*, libx11-dev, libxrandr-dev
libfreetype-dev, libfontconfig-dev
libasound2-dev, libatk1.0-dev, libgtk-3-dev

# Rust (installed via rustup)
```

### 2. Added `build-zed-ubuntu22` Command

New function in `stack` script that:

1. Checks for Zed source at `../zed`
2. Builds `zed-builder:ubuntu22` Docker image (first time only)
3. Runs cargo build inside container with mounted volumes:
   - Zed source at `/zed`
   - Cargo cache at `/root/.cargo` (persisted for fast rebuilds)
   - Output directory at `/output`
4. Copies binary to `./zed-build/zed`

**Usage:**
```bash
# Dev mode (fast, debug symbols)
./stack build-zed-ubuntu22

# Release mode (optimized, stripped)
./stack build-zed-ubuntu22 release
```

### 3. Preserved Existing Workflow

The original `build-zed` command is unchanged. Developers can choose:
- `./stack build-zed` - Host build (fast, for Sway on Ubuntu 25.04)
- `./stack build-zed-ubuntu22` - Docker build (for Ubuntu 22.04 compatibility)

## Files Created/Modified

| File | Change |
|------|--------|
| `Dockerfile.zed-build` | NEW - Ubuntu 22.04 build environment |
| `stack` | Added `build-zed-ubuntu22` function |

## Performance Considerations

**First Build:**
- Downloads and installs Rust (~1 min)
- Compiles all Zed dependencies from scratch (~10-15 min)
- Creates `zed-builder:ubuntu22` image

**Subsequent Builds:**
- Reuses Docker image
- Reuses cached cargo registry and compiled dependencies
- Only recompiles changed code (~1-3 min for incremental)

**Cache Location:**
- Docker image: `zed-builder:ubuntu22`
- Cargo cache: `~/.cargo-docker-cache/`

## Testing

After building with `./stack build-zed-ubuntu22`:

```bash
# Verify glibc requirements
objdump -T ./zed-build/zed | grep GLIBC | sort -u

# Should show GLIBC_2.35 or lower, NOT 2.38/2.39

# Rebuild Ubuntu container
./stack build-ubuntu

# Launch Ubuntu sandbox and verify Zed starts
```

## Why Ubuntu 22.04?

We chose Ubuntu 22.04 for the desktop container because:

1. **GNOME 42 Stability** - GNOME 44+ introduced X11 regressions that cause crashes with Wolf/Gamescope
2. **LTS Support** - 5-10 year support lifecycle (enterprise-grade)
3. **No MIT-SHM Crashes** - GNOME 48's edge-tiling preview animations cause crashes; GNOME 42 is stable
4. **Proven with Wolf** - Zorin (Ubuntu 22.04 based) works correctly with Wolf

See: `design/2025-12-10-ubuntu-22.04.md` for full rationale.

## Alternative Approaches Considered

1. **zig cc cross-compilation** - Zig can target specific glibc versions, but adds complexity
2. **musl static linking** - Fully static binary, but GPU/graphics libs may not work
3. **Older sysroot** - Complex toolchain setup

Docker-based build was chosen for simplicity and reliability.
