# Pure Ubuntu 22.04 Desktop Container

**Date:** 2025-12-10
**Status:** Implemented
**Branch:** `feature/ubuntu-desktop`

## Summary

Replaced the Zorin GOW base image with a pure Ubuntu 22.04 container to achieve:
1. Complete control over branding (no Zorin "Z" icon or theming)
2. GNOME 42 stability with Xwayland (no MIT-SHM crashes)
3. Enterprise-grade LTS with 5-10 year support
4. Developer familiarity with vanilla Ubuntu

## Research: GNOME 42/43 Stability

### Conclusion: GNOME 42 is the right choice

**Evidence supporting stability:**

1. **Ubuntu 22.04 LTS is enterprise-grade**
   - 5-10 year support (extended with Ubuntu Pro)
   - Battle-tested since April 2022
   - GNOME 42 with GTK4/libadwaita improvements
   - Wayland polished and "feels complete"

2. **GNOME 44+ introduced X11 regressions**
   - GNOME 45: X11 session restart crash ([Bug #2040453](https://bugs.launchpad.net/ubuntu/+source/mutter/+bug/2040453)) - "serious regression"
   - GNOME 44/45: Performance issues with NVIDIA + X11 (micro-stutter, resize lag)
   - GNOME 44+: Architectural changes broke window state restoration
   - Root cause: GTK3â†’GTK4 transition moved decoration rendering to separate process

3. **No MIT-SHM edge-tiling crashes reported for GNOME 42/43**
   - Our MIT-SHM crashes were specific to GNOME 48 edge-tiling preview animations
   - Search found no similar reports for GNOME 42/43

4. **Zorin container (Ubuntu 24.04/GNOME 42-43 fork) works correctly**
   - Real-world proof that older GNOME + Xwayland is stable under Wolf/Gamescope

**Sources:**
- [Ubuntu 22.04 LTS Features](https://linuxconfig.org/ubuntu-22-04-features-and-release-date)
- [GNOME 45 X11 Crash Bug](https://bugs.launchpad.net/ubuntu/+source/mutter/+bug/2040453)
- [GNOME 44/45 Regression Discussion](https://discourse.gnome.org/t/gnome-and-mutter-45-and-44-is-a-downgrade-to-gnome-43/18346)

## Implementation

### Files Created

#### GOW Infrastructure Scripts
Located in `wolf/ubuntu-config/`:

| File | Purpose |
|------|---------|
| `entrypoint.sh` | Container entrypoint - runs init scripts as root, switches to user |
| `gow/xorg.sh` | Starts Xwayland on :9, configures resolution |
| `gow/dbus.sh` | Starts D-Bus daemon |
| `gow/desktop.sh` | Launches GNOME session with Ubuntu environment |
| `gow/ensure-groups` | Adds user to device groups |
| `gow/bash-lib/utils.sh` | Utility functions (gow_log, join_by) |
| `cont-init.d/10-setup_user.sh` | Creates/configures retro user |
| `cont-init.d/15-setup_devices.sh` | Sets up device permissions |
| `cont-init.d/30-nvidia.sh` | Configures NVIDIA drivers and JSON configs |

#### Dockerfile Changes
`Dockerfile.ubuntu-helix` rewritten to:
- Use `ubuntu:22.04` base (was `ghcr.io/mollomm1/gow-zorin-18:latest`)
- Install GNOME 42 via `ubuntu-desktop-minimal`
- Install Ubuntu theming (Yaru theme, wallpapers, fonts)
- Install Firefox from Mozilla repo (not snap stub)
- Copy GOW infrastructure scripts
- Preserve all existing Helix functionality (Zed, Docker CLI, Go daemons)

### Key Configuration

#### dconf Settings (`wolf/ubuntu-config/dconf-settings.ini`)
- Ubuntu Yaru-dark theme
- Ubuntu wallpaper (`warty-final-ubuntu.png`)
- Ubuntu Dock extension enabled
- **Edge-tiling enabled** (safe on GNOME 42)

#### Environment Variables (in `desktop.sh`)
```bash
export XDG_CURRENT_DESKTOP=ubuntu:GNOME
export DE=gnome
export DESKTOP_SESSION=ubuntu
export GNOME_SHELL_SESSION_MODE="ubuntu"
export XDG_SESSION_TYPE=x11
export GDK_BACKEND=x11
```

## Issues Encountered and Fixes

### 1. Firefox Install Failure
**Problem:** `ubuntu-desktop-minimal` includes Firefox snap stub, Mozilla repo version was considered a downgrade.

**Fix:** Remove Firefox first, then install from Mozilla repo with `--allow-downgrades`:
```dockerfile
RUN apt-get remove -y firefox 2>/dev/null || true && \
    apt-get install -y --allow-downgrades firefox
```

### 2. Script Permission Denied (Exit Code 126)
**Problem:** Scripts created by Claude's Write tool had `-rw-------` permissions. Even after `chmod +x`, they were `-rwx--x--x` (execute-only for group/other).

**Root Cause:** Bash scripts need **read** permission to execute (unlike binary executables). The `chmod +x` only adds execute, not read.

**Fix:** Use `chmod 755` to set `rwxr-xr-x` permissions on all scripts.

### 3. Stale Image in Sandbox
**Problem:** After rebuilding, the sandbox's Docker daemon still had the old image cached.

**Fix:** Remove old images from sandbox before rebuild:
```bash
docker exec helix-sandbox-nvidia-1 docker rmi helix-ubuntu:TAG
./stack build-ubuntu
```

## Image Size Comparison

| Base Image | Size |
|------------|------|
| Zorin GOW (`ghcr.io/mollomm1/gow-zorin-18:latest`) | 8.11 GB |
| Pure Ubuntu 22.04 | 5.41 GB |
| Reduction | **33%** |

## Commits

1. `feat(ubuntu): pure Ubuntu 22.04 container with GNOME 42`
2. `fix(ubuntu): fix Firefox install on pure Ubuntu 22.04`
3. `fix(ubuntu): add execute permissions to GOW scripts`

## Testing

To test the Ubuntu container:
1. Ensure the image is built: `./stack build-ubuntu`
2. Launch a new Ubuntu sandbox from the UI
3. Verify:
   - Ubuntu branding (Yaru theme, Ubuntu wallpaper, no "Z" icon)
   - Edge-tiling works without crashes
   - Firefox and Terminal launch correctly

## Future Considerations

1. **Ubuntu 24.04 Upgrade Path:** Once GNOME 46+ stabilizes, consider upgrading. Monitor [mutter issues](https://gitlab.gnome.org/GNOME/mutter/-/issues) for X11/Xwayland regression fixes.

2. **MIT-SHM Monitoring:** If MIT-SHM issues appear, disable edge-tiling in `dconf-settings.ini`:
   ```ini
   [org/gnome/mutter]
   edge-tiling=false
   ```

3. **Startup Speed:** The Ubuntu 22.04 container may start slower than Zorin due to full GNOME session initialization. Consider profiling if this becomes an issue.
