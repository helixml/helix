# Design Document Review Workflow

**Date:** 2025-11-11
**Status:** IMPLEMENTED (Backend Complete, Frontend In Progress)
**Feature:** Automated design doc review system with inline commenting

## Overview

This feature implements a complete design document review workflow that automatically detects when agents push design docs to Git, creates review sessions, and provides a beautiful UI for human reviewers to comment on and approve/reject designs before implementation begins.

## Problem Statement

Previously, design docs generated by AI agents went straight to implementation without proper human review. This led to:
- Missed architectural issues
- Unclear requirements making it to code
- Wasted implementation effort on wrong approaches
- No formal approval process

## Solution Architecture

### Three-Phase Workflow

```
Phase 1: Spec Generation (Agent)
  â†“
Phase 2: Human Review (This Feature)
  â†“
Phase 3: Implementation (Agent)
```

### Component Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Git Repository                           â”‚
â”‚  (Agent pushes design docs to design/ folder)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              SpecTaskGitMonitor Service                      â”‚
â”‚  - Polls every 30s for new commits                           â”‚
â”‚  - Detects changes in design/, docs/design/, .helix/design/  â”‚
â”‚  - Creates SpecTaskDesignReview on detection                 â”‚
â”‚  - Auto-updates Kanban: spec_generation â†’ spec_review        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 PostgreSQL Database                          â”‚
â”‚  - spec_task_design_reviews                                  â”‚
â”‚  - spec_task_design_review_comments                          â”‚
â”‚  - spec_task_design_review_comment_replies                   â”‚
â”‚  - spec_task_git_push_events                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     REST API                                 â”‚
â”‚  GET    /api/v1/spec-tasks/{id}/design-reviews              â”‚
â”‚  GET    /api/v1/spec-tasks/{id}/design-reviews/{review_id}  â”‚
â”‚  POST   .../design-reviews/{review_id}/submit               â”‚
â”‚  POST   .../design-reviews/{review_id}/comments             â”‚
â”‚  GET    .../design-reviews/{review_id}/comments             â”‚
â”‚  POST   .../comments/{comment_id}/resolve                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               React Frontend (In Progress)                   â”‚
â”‚  - DesignReviewViewer: Beautiful markdown renderer           â”‚
â”‚  - CommentThread: Inline section commenting                  â”‚
â”‚  - ReviewControls: Approve/Request Changes UI                â”‚
â”‚  - Kanban integration: "Review Design" button                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Database Schema

### SpecTaskDesignReview

```sql
CREATE TABLE spec_task_design_reviews (
  id VARCHAR(255) PRIMARY KEY,
  spec_task_id VARCHAR(255) NOT NULL,
  reviewer_id VARCHAR(255),
  status VARCHAR(50) NOT NULL DEFAULT 'pending',

  -- Git tracking
  git_commit_hash VARCHAR(255) NOT NULL,
  git_branch VARCHAR(255) NOT NULL,
  git_pushed_at TIMESTAMP NOT NULL,

  -- Document snapshots (captured at review creation)
  requirements_spec TEXT,
  technical_design TEXT,
  implementation_plan TEXT,

  -- Review decision
  overall_comment TEXT,
  approved_at TIMESTAMP,
  rejected_at TIMESTAMP,

  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);
```

**Status enum:**
- `pending` - Waiting for reviewer to start
- `in_review` - Reviewer actively reviewing
- `changes_requested` - Reviewer rejected, agent must fix
- `approved` - Approved, ready for implementation
- `superseded` - Newer review exists (agent pushed updates)

### SpecTaskDesignReviewComment

```sql
CREATE TABLE spec_task_design_review_comments (
  id VARCHAR(255) PRIMARY KEY,
  review_id VARCHAR(255) NOT NULL,
  commented_by VARCHAR(255) NOT NULL,

  -- Location in document
  document_type VARCHAR(50) NOT NULL, -- 'requirements', 'technical_design', 'implementation_plan'
  section_path TEXT, -- e.g., "## Architecture/### Database Schema"
  line_number INTEGER,
  quoted_text TEXT, -- Text being commented on
  start_offset INTEGER, -- Character offset for inline highlighting
  end_offset INTEGER,

  -- Comment content
  comment_text TEXT NOT NULL,
  comment_type VARCHAR(50) DEFAULT 'general', -- 'general', 'question', 'suggestion', 'critical', 'praise'

  -- Resolution tracking
  resolved BOOLEAN DEFAULT FALSE,
  resolved_by VARCHAR(255),
  resolved_at TIMESTAMP,

  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);
```

### SpecTaskDesignReviewCommentReply

```sql
CREATE TABLE spec_task_design_review_comment_replies (
  id VARCHAR(255) PRIMARY KEY,
  comment_id VARCHAR(255) NOT NULL,
  replied_by VARCHAR(255) NOT NULL,
  reply_text TEXT NOT NULL,
  is_agent BOOLEAN DEFAULT FALSE, -- True if agent replied
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);
```

### SpecTaskGitPushEvent

```sql
CREATE TABLE spec_task_git_push_events (
  id VARCHAR(255) PRIMARY KEY,
  spec_task_id VARCHAR(255) NOT NULL,

  -- Git details
  commit_hash VARCHAR(255) NOT NULL,
  branch VARCHAR(255) NOT NULL,
  author_name VARCHAR(255),
  author_email VARCHAR(255),
  commit_message TEXT,
  pushed_at TIMESTAMP NOT NULL,

  -- Processing
  processed BOOLEAN DEFAULT FALSE,
  processed_at TIMESTAMP,
  processing_error TEXT,
  files_changed JSONB, -- Array of changed file paths

  -- Metadata
  event_source VARCHAR(50), -- 'webhook', 'polling', 'manual'
  raw_payload JSONB,
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);
```

## Backend Implementation

### Git Monitoring Service

**File:** `api/pkg/services/spec_task_git_monitor.go`

**Key features:**
- Polls repositories every 30 seconds (configurable)
- Uses go-git to detect new commits
- Filters for design doc paths: `design/`, `docs/design/`, `.helix/design/`
- Only processes commits with `.md` files in design directories
- Idempotent: won't process same commit twice
- Marks old reviews as `superseded` when new push detected

**Algorithm:**
```go
for each spec_task in status="spec_generation":
  repo = get_project_repository(spec_task.project_id)
  head_commit = repo.HEAD()

  if not already_processed(head_commit):
    design_docs_changed = check_design_doc_changes(head_commit)

    if design_docs_changed:
      supersede_old_reviews(spec_task.id)
      create_design_review(spec_task, head_commit)
      update_spec_task_status(spec_task, "spec_review")
      log.info("Design review created")
```

### Store Methods

**File:** `api/pkg/store/spec_task_design_review_store.go`

Standard CRUD operations plus:
- `GetLatestDesignReview()` - Get most recent review for spec task
- `ListUnresolvedComments()` - Get all unresolved comments
- `GetSpecTaskDesignReviewWithComments()` - Optimized join query
- `SpecTaskNeedsReview()` - Check if pending/in_review exists

### API Handlers

**File:** `api/pkg/server/spec_task_design_review_handlers.go`

All handlers use standard authorization checks via `authorizeUserToResource()`.

**Submit review flow:**
```go
if decision == "approve":
  review.status = "approved"
  spec_task.status = "spec_approved"
  spec_task.approved_by = user.id
  spec_task.approved_at = now()

else if decision == "request_changes":
  review.status = "changes_requested"
  spec_task.status = "spec_revision"
  spec_task.spec_revision_count++
  notify_agent_of_changes(spec_task, review)
```

## Frontend Implementation (In Progress)

### Design Principles

1. **Beautiful, Paper-Like Design**
   - Clean serif fonts (Georgia, Palatino)
   - Black text on white/cream background
   - Generous whitespace
   - Subtle shadows and borders
   - LaTeX-inspired typography

2. **Intuitive Commenting**
   - Click any paragraph to comment
   - Visual highlight on hover
   - Color-coded comment types
   - Thread replies inline
   - Keyboard shortcuts (c=comment, r=resolve)

3. **Efficient Review Flow**
   - Single-page review experience
   - Sticky navigation between documents
   - Unresolved comments counter
   - Quick approve/reject buttons
   - Auto-save drafts

### Component Structure

```
DesignReviewViewer (Main Container)
â”œâ”€â”€ ReviewHeader
â”‚   â”œâ”€â”€ Spec task title
â”‚   â”œâ”€â”€ Git commit info
â”‚   â”œâ”€â”€ Status badge
â”‚   â””â”€â”€ Unresolved comments count
â”œâ”€â”€ DocumentTabs
â”‚   â”œâ”€â”€ Requirements Spec
â”‚   â”œâ”€â”€ Technical Design
â”‚   â””â”€â”€ Implementation Plan
â”œâ”€â”€ MarkdownContent (with comment highlights)
â”‚   â”œâ”€â”€ Parsed markdown with syntax highlighting
â”‚   â”œâ”€â”€ Hover states for commentable sections
â”‚   â”œâ”€â”€ Inline comment bubbles
â”‚   â””â”€â”€ Selected text highlighting
â”œâ”€â”€ CommentPanel (Sidebar)
â”‚   â”œâ”€â”€ Comment threads list
â”‚   â”œâ”€â”€ Filter by document/type
â”‚   â”œâ”€â”€ Resolve/unresolve toggles
â”‚   â””â”€â”€ Reply interface
â””â”€â”€ ReviewControls (Footer)
    â”œâ”€â”€ Overall comment textarea
    â”œâ”€â”€ Approve button (green)
    â”œâ”€â”€ Request Changes button (orange)
    â””â”€â”€ Save Draft button
```

### React Query Hooks

**File:** `frontend/src/services/designReviewService.ts`

```typescript
// Query hooks
export const useDesignReviews = (specTaskId: string)
export const useDesignReview = (specTaskId: string, reviewId: string)
export const useDesignReviewComments = (specTaskId: string, reviewId: string)

// Mutation hooks
export const useSubmitReview = ()
export const useCreateComment = ()
export const useResolveComment = ()
export const useReplyToComment = ()
```

### Comment Types & Colors

| Type       | Color  | Icon | Use Case                          |
|------------|--------|------|-----------------------------------|
| General    | Blue   | ğŸ’¬   | General feedback                  |
| Question   | Yellow | â“   | Needs clarification               |
| Suggestion | Purple | ğŸ’¡   | Improvement idea                  |
| Critical   | Red    | âš ï¸   | Must fix before approval          |
| Praise     | Green  | âœ…   | Positive feedback                 |

## User Workflows

### Happy Path: Approve Design

1. Agent generates design docs, commits to `design/2025-11-11-feature-name.md`
2. Git monitor detects push within 30s
3. Creates design review, updates Kanban card status
4. Reviewer sees "Review Design" button on card
5. Clicks button â†’ Opens floating window with markdown viewer
6. Reviews requirements, technical design, implementation plan
7. Adds a few questions as comments
8. Agent sees comments via WebSocket, replies to threads
9. Reviewer marks all as resolved
10. Clicks "Approve" â†’ Status changes to `spec_approved`
11. "Start Implementation" button appears
12. Clicks button â†’ Creates feature branch, initializes Zed workspace
13. Agent begins implementation on new branch

### Revision Path: Request Changes

1-6. Same as above
7. Reviewer finds architectural flaw, adds critical comment
8. Clicks "Request Changes" with overall comment
9. Review status â†’ `changes_requested`, spec task â†’ `spec_revision`
10. Agent receives notification with all comments
11. Agent updates design docs addressing feedback
12. Agent commits and pushes updated docs
13. Git monitor detects new commit
14. Old review marked `superseded`, new review created
15. Reviewer sees updated design, verifies fixes
16. Approves â†’ Proceeds to implementation

## Integration Points

### Kanban Board Changes

**File:** `frontend/src/components/SpecTasksKanban.tsx`

Add to card when `status === 'spec_review'`:
```tsx
<Button
  onClick={() => openReviewWindow(task.id)}
  variant="outlined"
  color="primary"
>
  Review Design
  {unresolvedCount > 0 && (
    <Badge badgeContent={unresolvedCount} color="error" />
  )}
</Button>
```

### Agent WebSocket Notification

When review submitted with `decision === 'request_changes'`:

```json
{
  "type": "design_review_changes_requested",
  "spec_task_id": "st_abc123",
  "review_id": "stdr_xyz789",
  "overall_comment": "Please address concerns about database schema",
  "comments": [
    {
      "id": "stdrc_123",
      "document_type": "technical_design",
      "section_path": "## Database Schema",
      "comment_text": "Should we use UUID instead of auto-increment?",
      "comment_type": "critical",
      "quoted_text": "id SERIAL PRIMARY KEY"
    }
  ]
}
```

Agent receives this, reads comments, updates design docs, commits.

### Feature Branch Creation

When user clicks "Accept and Start Implementation":

```javascript
POST /api/v1/spec-tasks/{id}/start-implementation

Response:
{
  "branch_name": "feature/add-user-authentication-st_abc123",
  "base_branch": "main",
  "created_at": "2025-11-11T10:30:00Z",
  "zed_workspace_path": "/workspaces/spectasks/st_abc123/work",
  "pr_template_url": "https://github.com/org/repo/compare/feature/add-user-authentication-st_abc123"
}
```

## Configuration

### Git Monitor Settings

**Environment Variables:**
```bash
GIT_MONITOR_POLL_INTERVAL=30s  # How often to check for updates
GIT_MONITOR_DESIGN_PATHS=design/,docs/design/,.helix/design/
GIT_MONITOR_FILE_EXTENSIONS=.md,.markdown
```

### WebRTC Port Range (Already Fixed)

Expanded from 10 â†’ 100 ports to support concurrent streaming sessions during review.

## Testing Strategy

### Unit Tests
- Store methods with mock database
- Git monitor logic with test repository
- Comment threading and resolution

### Integration Tests
- Full review cycle: push â†’ detect â†’ create â†’ comment â†’ approve
- Concurrent reviews on different spec tasks
- Supersede old review when new commit detected

### E2E Tests
- Agent pushes design â†’ Human reviews â†’ Agent addresses feedback â†’ Approved â†’ Implementation starts
- Test with real Git repository (test fixtures)

## Future Enhancements

### V2 Features (Not Implemented Yet)
1. **Diff View** - Show changes between review versions
2. **Suggested Edits** - Reviewer can propose inline edits (like GitHub suggestions)
3. **Review Templates** - Common review checklists
4. **Multi-Reviewer** - Require 2+ approvals
5. **Review Metrics** - Time to approve, revision count trends
6. **Email Notifications** - Alert reviewers of pending reviews
7. **Slack Integration** - Post review requests to channel
8. **AI-Assisted Review** - LLM pre-checks for common issues

### Known Limitations
1. **Webhook Support** - Currently polling only, webhook parsing commented out
2. **Repo Matching** - Webhook â†’ SpecTask mapping not implemented
3. **Concurrent Reviews** - Only one active review per spec task
4. **Large Files** - No pagination for huge design docs
5. **Images** - Markdown images not yet supported in comments

## Deployment Notes

### Database Migration
Auto-migrates on API startup via GORM AutoMigrate:
```go
db.AutoMigrate(
  &types.SpecTaskDesignReview{},
  &types.SpecTaskDesignReviewComment{},
  &types.SpecTaskDesignReviewCommentReply{},
  &types.SpecTaskGitPushEvent{},
)
```

### Starting Git Monitor

Add to API server initialization:
```go
gitMonitor := services.NewSpecTaskGitMonitor(
  store,
  gitRepoService,
  30*time.Second, // poll interval
)

go gitMonitor.Start(ctx)
```

### Port Requirements
- Existing API ports (unchanged)
- WebRTC ports 40000-40100 (already configured)
- No additional ports needed

## Success Metrics

Track these metrics post-launch:
1. **Review Turnaround Time** - Time from push to approval
2. **Revision Rate** - % of reviews requesting changes
3. **Comment Quality** - Ratio of critical/question comments
4. **Agent Fix Rate** - % of issues agent resolves on first try
5. **Implementation Success** - Fewer bugs from unclear designs

## References

- Design doc investigation: `design/2025-11-10-second-moonlight-connection-failure-investigation.md`
- Original spec task system: `api/pkg/types/simple_spec_task.go`
- Multi-session architecture: `api/pkg/types/spec_task_multi_session.go`
- Git repository service: `api/pkg/services/git_repository_service.go`

## Conclusion

This feature creates a critical quality gate between AI-generated designs and implementation. By forcing human review of design documents with a beautiful, efficient UI and automated Git integration, we ensure that only well-thought-out designs proceed to implementation, saving significant development time and improving code quality.

**Status:** Backend 100% complete and deployed. Frontend implementation in progress (estimated 2-3 hours remaining for full UI).
